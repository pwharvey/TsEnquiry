/*!
* Data Aquarium Framework - Charts for Touch UI
* Copyright 2008-2016 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function e(n){return n.match(/pie|donut/i)}function n(n,t,i,r){i||(i="visualization");r||(r="1");var f=i+r+(typeof n=="string"?n:n.join("-")),u=s[f];u&&u.loaded?t():u&&!u.loaded?u.callbacks.push(t):($app.touch.busyIndicator(!0),u=s[f]={loaded:!1,callbacks:[t]},google.load(i,r,{packages:n,callback:function(){$app.touch.busyIndicator(!1);u.loaded=!0;$(u.callbacks).each(function(){this()})}}))}function c(t,i){var u=$('<div class="app-chart-headerbar"><\/div>').appendTo(i),e=$('<div class="app-chart-mini"><\/div>').appendTo(u).attr("title",r.ShowChart),s=t.Properties.title||t.Title,a=$('<span class="app-chart-header"><\/span>').appendTo(u),f=$('<div class="app-chart-data app-scrollable"><\/div>').appendTo(i),h=$("<table><\/table>").appendTo(f),c=!t.ChartType.match(/map|table/);c||e.hide();i.closest(".app-chart").addClass("app-chart-has-data");t.ShowData=!0;n("corechart",function(){var r=google.visualization.arrayToDataTable(t.ChartData),p=r.getNumberOfRows(),y=r.getNumberOfColumns(),v=$("<tr><\/tr>").appendTo(h),u,i,n,f;for(a.text(s.substring(0,1).toUpperCase()+s.substring(1)),l(t,r),i=0;i<y;i++)n=r.getColumnLabel(i),f=$("<th><\/th>").appendTo(v),n!=null&&f.text(n).attr("title",n);for(u=0;u<p;u++)for(v=$("<tr><\/tr>").appendTo(h),i=0;i<y;i++)n=r.getFormattedValue(u,i),f=$("<td><\/td>").appendTo(v),n!=null&&f.text(n=="0"?"":n).attr("title",n);c&&o(t,e)});f.height(Math.floor(i.height()-u.outerHeight(!0)));f.width(i.width())}function o(n,t){var i=a[n.ChartType];i&&i(n,t)}function t(n,t,i){var u=e(n.ChartType),h=n.Properties.title||n.Title,o,r,f,s;i||(i={});i.legend||(i.legend={});i.hAxis||(i.hAxis={});i.vAxis||(i.vAxis={});i.chartArea||(i.chartArea={});i.tooltip||(i.tooltip={});i.title=h.charAt(0).toUpperCase()+h.slice(1);i.width=Math.floor(t.width())-1;i.height=Math.floor(t.height())-1;i.tooltip.trigger="focus";n.ChartData[0].length<=2&&(u||(i.legend.position="none"),u&&(n.Properties.maximize=!0));u&&(i.sliceVisibilityThreshold=0);for(o in n.Properties)if(n.Properties.hasOwnProperty(o)){r=n.Properties[o];switch(o){case"crosshair":i.crosshair={orientation:r==0?"both":r,trigger:"both"};break;case"maximize":u?(i.chartArea.top="15%",i.chartArea.width="80%",i.chartArea.height="80%"):(i.titlePosition="in",i.chartArea.width="100%",i.chartArea.height="100%",i.legend.position||(i.legend.position="in"));i.axisTitlesPosition="in";i.hAxis.textPosition="in";i.vAxis.textPosition="in";break;case"haxistitle":i.hAxis.title=r;break;case"vaxistitle":i.vAxis.title=r;break;case"region":i.region=r;break;case"displaymode":i.displayMode=r;break;case"resolution":i.resolution=r;break;case"curve":i.curveType="function";break;case"explorer":i.explorer={};break;case"maptype":i.mapType=r;break;case"enablescrollwheel":i.enableScrollWheel=!0;break;case"usemaptypecontrol":i.useMapTypeControl=!0;break;case"pointshape":i.pointShape=r;break;case"pointsize":i.pointSize=r;break;case"orientation":i.orientation=r;break;case"animation":i.animation={startup:!0,duration:500,easing:"out"};break;case"colors":f=r.split(",");for(s in f)f[s]=f[s].trim();i.colors=f}}return n.ShowData&&(i.legend.position="none",i.axisTitlesPosition="none",i.height="100%",i.titlePosition="none",i.chartArea.top="0",i.chartArea.width="100%",i.chartArea.height="100%",i.enableInteractivity=!1),$("body").hasClass("app-theme-dark")&&(i.backgroundColor="#1f1f1f",i.hAxis.textStyle={color:"white"},i.hAxis.gridlines={color:"#000"},i.vAxis.textStyle={color:"white"},i.vAxis.gridlines={color:"#000"},i.legend.textStyle={color:"#999"},i.legend.scrollArrows={activeColor:"#fff",inactiveColor:"#777"},i.legend.pagingTextStyle={color:"#999"},i.titleTextStyle={color:"white"},u&&(i.pieSliceBorderColor="#111")),i}function l(n,t){var o=n.ValueFieldNames.length,c=n.ValueFieldNames.length,r;for(name in n.Formats){var i=n.Formats[name],u=/(\w+)(\d)/.exec(name),s=u[1],h=u[2],f=n.ValueFieldNames.indexOf(s,h),e;if(f!=-1&&i){switch(i.toLowerCase()){case"c":case"C":i="Â¤00.00";break;case"d":case"D":i="00.00";break;case"e":case"E":i="0.######E+000";break;case"f":case"F":i="00.00";break;case"n":case"N":i="00.00";break;case"p":case"P":i="%";break;case"x":case"X":i="00.00"}for(e=new google.visualization.NumberFormat({pattern:i}),r=f+1;r<n.Data[0].length;r=r+o)e.format(t,r)}}}function i(n,t,i,r){function o(){}var f=google.visualization.arrayToDataTable(n.ChartData),e=n.ChartType.match(/geo/i);l(n,f);u.desktop()||e||o();n.Properties.animation&&!e&&n.ChartType!="map"&&i.draw(null,r);i.draw(f,r);u.desktop()&&!e&&(google.visualization.events.addListener(i,"select",function(){if(r.tooltip.trigger=="focus"){r.tooltip.trigger="selection";var n=i.getSelection();return o(),i.draw(f,r),i.setSelection(n),!1}}),google.visualization.events.addListener(i,"click",function(n){n.targetID.match(/^action/)||r.tooltip.trigger!="selection"||(r.tooltip.trigger="focus",i.removeAction("filter"),i.removeAction("exclude"),i.setSelection(null),i.draw(f,r))}))}var v=$(window),y=$.mobile,u=$app.touch,s={},r=Web.DataViewResources.Presenters.Charts,f=Web.DataViewResources.Mobile,h,a;$(document).on("resizing.app",function(){$.mobile.activePage.find(".app-chart-inner").children().hide()}).on("searching.app",function(n){var t=n.dataView._id;$("#"+t+'.ui-page .app-wrapper > [data-presenter="Charts"] .app-chart-inner, .app-echo[data-for="'+t+'"] .app-chart-inner').children().hide()}).on("vclick",".app-chart",function(n){function w(){delete e.ShowData;i.viewProp("chartsConfig",l);var r=t.closest(".app-chart-list").parent().data("pivots")["pivot"+p],n=t.closest(".app-chart").find(".app-chart-inner");n.empty();n.closest(".app-chart").removeClass("app-chart-has-data");r.ShowData=!1;o(r,n)}var t=$(n.target),b=t.closest(".app-echo"),i=b.length?$app.find(b.attr("data-for")):u.dataView(),h=t.closest(".app-chart").data("data-context");if(i&&h){var p=h.Id,l=i.viewProp("chartsConfig"),e=l&&l[p],v=!$("body").hasClass("app-sidebar-undocked"),y=$(window).width()/parseFloat($("body").css("font-size")),k=v&&y>=50||!v&&y>=40,d=v&&y>=85||!v&&y>=62,a=e.size?e.size:"small",s=[];return t.is(".app-btn-more")&&!$app.mobile.busy()?($app.mobile.callWithFeedback(t.closest(".ui-btn"),function(){a!="large"||d||(a="medium");a!="medium"||k||(a="small");var n=t.closest(".app-chart-list").parent().data("pivots")["pivot"+p];n.ChartType.match(/map|table/)||(e.ShowData?s.push({text:r.ShowChart,icon:"chart",callback:w}):s.push({text:r.ShowData,icon:"grid",callback:function(){e.ShowData=!0;i.viewProp("chartsConfig",l);var r=t.closest(".app-chart").find(".app-chart-inner");r.empty();c(n,r)}}));t.closest(".app-chart-list").find(".app-chart").length>1?(s.push({text:r.Sizes.Label}),s.push({text:r.Sizes.Small,icon:a=="small"?"check":"",callback:function(){delete e.size;e.resized=!0;i.viewProp("chartsConfig",l);$app.touch.presenter("show",{name:"Charts",id:i._id,container:t.closest(".app-wrapper")})}}),k&&s.push({text:r.Sizes.Medium,icon:a=="medium"?"check":"",callback:function(){e.size="medium";e.resized=!0;i.viewProp("chartsConfig",l);$app.touch.presenter("show",{name:"Charts",id:i._id,container:t.closest(".app-wrapper")})}}),d&&s.push({text:r.Sizes.Large,icon:a=="large"?"check":"",callback:function(){e.size="large";e.resized=!0;i.viewProp("chartsConfig",l);$app.touch.presenter("show",{name:"Charts",id:i._id,container:t.closest(".app-wrapper")})}})):s.push({text:r.Sizes.Auto,icon:"check",callback:function(){}});s.push({text:f.Filter});h.ColumnFieldNames&&h.ColumnFieldNames.length&&s.push({text:i.findField(h.ColumnFieldNames[0]).HeaderText,icon:"filter",callback:function(){u.configureFilter({field:h.ColumnFieldNames[0],scope:i._id,mode:"field"})}});h.RowFieldNames&&h.RowFieldNames.length&&s.push({text:i.findField(h.RowFieldNames[0]).HeaderText,icon:"filter",callback:function(){u.configureFilter({field:h.RowFieldNames[0],scope:i._id,mode:"field"})}});u.listPopup({anchor:t.closest("a"),iconPos:"right",items:s})}),!1):t.closest(".app-chart-mini").length?(w(),!1):void 0}}).on("taphold",".app-chart",function(n){var t=$(n.target);t.is("td")&&t.closest(".app-chart-data").length&&u.listPopup({anchor:t,title:t.text()})});a={area:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.AreaChart($(u).get(0));i(r,u,f,n)})},areastacked:function(r,u){n("corechart",function(){var n=t(r,u,{isStacked:!0}),f=new google.visualization.AreaChart($(u).get(0));i(r,u,f,n)})},bar:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.BarChart($(u).get(0));i(r,u,f,n)})},barstacked:function(r,u){n("corechart",function(){var n=t(r,u,{isStacked:!0}),f=new google.visualization.BarChart($(u).get(0));i(r,u,f,n)})},column:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.ColumnChart($(u).get(0));i(r,u,f,n)})},columnstacked:function(r,u){n("corechart",function(){var n=t(r,u,{isStacked:!0}),f=new google.visualization.ColumnChart($(u).get(0));i(r,u,f,n)})},candlestick:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.CandlestickChart($(u).get(0));i(r,u,f,n)})},donut:function(r,u){n("corechart",function(){var n=t(r,u,{pieHole:.4,backgroundColor:"transparent"}),f=new google.visualization.PieChart($(u).get(0));i(r,u,f,n)})},geo:function(r,u){n("geochart",function(){var n=t(r,u,{backgroundColor:"transparent"}),f=new google.visualization.GeoChart($(u).get(0));i(r,u,f,n)})},map:function(r,u){n("map",function(){var n=t(r,u,{showTip:!0}),f=new google.visualization.Map($(u).get(0));i(r,u,f,n)})},line:function(r,u){n("corechart",function(){var n=t(r,u,{showTip:!0}),f=new google.visualization.LineChart($(u).get(0));i(r,u,f,n)})},pie:function(r,u){n("corechart",function(){var n=t(r,u,{title:r.Title,backgroundColor:"transparent"}),f=new google.visualization.PieChart($(u).get(0));i(r,u,f,n)})},pie3d:function(r,u){n("corechart",function(){var n=t(r,u,{backgroundColor:"transparent",is3D:!0}),f=new google.visualization.PieChart($(u).get(0));i(r,u,f,n)})},scatter:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.ScatterChart($(u).get(0));i(r,u,f,n)})},table:function(r,u){n("table",function(){var n=t(r,u),f=new google.visualization.Table($(u).get(0));i(r,u,f,n)})}};$app.touch.presenter("register",{name:"Charts",icon:function(){return"chart"},text:function(){return r.Text},supports:function(n){var u=!1;if($(n._fields).each(function(){if(this.Tag&&this.Tag.indexOf("pivot")!=-1)return u=!0,!1}),u)n.AutoPivots=null;else{if(n.AutoPivots&&$.isEmptyObject(n.AutoPivots))return!0;n.AutoPivots={};var t=1,g=n._fields[0].Label,i=[],o=0,v=0,h=["pie3d","column","donut","bar"],r=[],f=0,y=0,c=["line","column","area"],p=0,l=["columnstacked-top5","area-top7","column-top5","barstacked-top5"],w=[],a=n.groupExpression(),b=!1,s=function(){return h[v++%h.length]},k=function(){return c[y++%c.length]},d=function(){return l[p++%l.length]};$(n._fields).each(function(){var u=this;n.AutoPivots[u.Name]=[];(u.ItemsDataController||u.AliasName)&&i.push(u.Name);u.Type=="DateTime"&&r.push(u.Name);u.DataFormatString=="c"&&w.push(u.Name);a&&a[0]==(u.AliasName||u.Name)&&n.AutoPivots[u.Name].push("pivot"+t+++"-row1-top10-sortdescbyvalue-"+(u.Type=="String"?"pie-other":"column"))});$(i).each(function(){if(t>9||!r[f])return!1;var u=this,e=r[f];n.AutoPivots[i[o++%i.length]].push("pivot"+t+"-col1-sortdescbyvalue-"+d());n.AutoPivots[r[f++%r.length]].push("pivot"+t+++"-row1-date-all-hideblank")});o=0;f=0;$(n._fields).each(function(){var u,r,f,h;if(t>9)return!1;if(u=this,r=u.Name,u.IsPrimaryKey)return!0;(u.ItemsDataController||u.AliasName)&&n.AutoPivots[r].push("pivot"+t+++"-row1-top10-other-sortdescbyvalue-"+s());switch(u.Type){case"Int16":case"Int32":case"Int64":case"Single":case"Double":case"Decimal":if(i.length!=0&&!(u.ItemsDataController||u.AliasName)){if(f="sum",h=s(),r.match(/salary/i))f="avg";else if(r.match(/total/i))f="sum";else if(u.DataFormatString=="{0:c}"||r.match(/price|discount/i))for(f="avg";e(h);)h=s();e(h)&&(f="sum");n.AutoPivots[r].push("pivot"+t+"-val1-"+f+"-"+h);n.AutoPivots[i[o++%i.length]].push("pivot"+t+++"-row1-top7-other-sortdescbyvalue")}break;case"DateTime":r.match(/birth|hire/i)?n.AutoPivots[r].push("pivot"+t+++"-row1-month-all-pie3d"):n.AutoPivots[r].push("pivot"+t+++"-row1-"+k()+"-date-all-hideblank");break;case"String":b||r.match(/country/i)&&n.AutoPivots[r].push("pivot"+t+++"-row1-geo")}});t>1&&(u=!0)}return u},show:function(n){function a(n){var u,e,o,s,h;v();u=$('<ul class="app-listview app-grid"/>').appendTo(i);n?(s=$('<li data-icon="filter" class="ui-last-child"><a href="#app-filter" class="ui-btn ui-icon-filter ui-btn-icon-left"><p/><\/a><\/li>').appendTo(u).find("a"),h=String.format(r.DataWarning,__settings.maxPivotRowCount),s.attr("title",f.Filter).find("p").text(h)):(e=$('<li data-icon="refresh"><a href="#app-refresh" class="ui-btn ui-icon-refresh ui-btn-icon-left"><p/><\/a><\/li>').appendTo(u).find("a"),e.attr("title",Web.DataViewResources.Pager.Refresh).find("p").text(Web.DataViewResources.Data.NoRecords),t._filter&&t._filter.length&&!t.filterIsExternal()&&(o=$('<li data-icon="filter" class="ui-last-child"><a href="#app-clear-filter" class="ui-btn ui-icon-filter ui-btn-icon-left"><p/><\/a><\/li>').appendTo(u).find("a"),o.attr("title",f.ClearFilter).find("p").text(f.ClearFilter)));u.listview()}function v(){i.find(".app-chart").each(function(){$(this).removeData()});i.empty()}function p(n){for(pivot in n)$(n[pivot].Data).each(function(){for(var t=this,n=0;n<t.length;)t[n]=y(t[n]),n++}),n[pivot].Title=y(n[pivot].Title),n[pivot].ChartData=JSON.parse(JSON.stringify(n[pivot].Data)),$(n[pivot].ChartData).each(function(){for(var i=this,t=this,n=0,n=0;n<t.length;n++)t[n]==null&&(t[n]=0)})}function y(n){if(!n||!isNaN(n)||isFinite(n))return n;var i=n.match(/\$(\S+)/g);return $(i).each(function(){var f=this.replace(/\d*/g,""),i=f.replace(/[$\d]*/g,""),u=r.ChartLabels[i];u?(i.match(/Quarter|Week/)&&(u=u.substring(0,1)),n=n.replace(f,u)):i=="CurrentViewLabel"&&(n=n.replace(f,t._view.Label));i=="Other"&&(n.isOther=!0)}),n}function l(){var y,h,f,n,b,nt=[],ut=0,p=i.closest(".app-wrapper"),tt,l=0,g=1,k,ft=i.find(".app-chart"),it,rt,d=!1,ot,w;ft.length>0&&(ot=p.scrollTop(),$(ft).each(function(){var n=$(this);if(n.position().top>0)return s[n.data("data-context").Id].lastScrollPosition=!0,!1}));v();$('<div class="app-chart"><span class="app-chart-inner"/><\/div><div class="app-chart"><span class="app-chart-inner"/><\/div><div class="app-chart"><span class="app-chart-inner"/><\/div>').appendTo(i);k=i.find(".app-chart");$(k[0]).offset().left<$(k[1]).offset().left&&g++;$(k[1]).offset().left<$(k[2]).offset().left&&g++;k.remove();i.empty();for(b in e)if(n=e[b],n.ChartType&&n.RecordCount!=0)d||(n.Properties.medium||n.Properties.large?d=!0:s&&(config=s[n.Id],config&&config.size&&config.size.match(/medium|large/)&&(d=!0))),l++;else continue;l==1&&(d=!0);for(b in e)(n=e[b],placeholder=$('<div class="app-chart"><\/div>').data("data-context",n),inner=$('<span class="app-chart-inner"><\/span>').appendTo(placeholder),moreBtn=$('<a class="ui-btn"><span class="app-btn-more">&nbsp;<\/span><\/a>').appendTo(placeholder).attr("title",r.More),n.ChartType&&n.RecordCount!=0)&&(placeholder.appendTo(i),y||(f=p.height(),tt=p.find(".app-presenter-instruction:visible"),tt.length&&(f-=tt.outerHeight()),f=Math.floor(f),y=inner.width(),h=g==3?l<=3?Math.min(f,y*1.33):Math.min(y*.66,Math.max(f/3,y*.5))-1:g==2?l<=4?Math.max(f/2,y*.5):y*.66:f*.66,d&&l<=3&&(h=f*.5),h>f&&(h=y*.66,h>f&&(h=f)),h=Math.floor(h)),w=h,config=s[n.Id],config||(config=s[n.Id]={}),config.size||(n.Properties.small!=null?delete config.size:n.Properties.medium!=null?config.size="medium":n.Properties.large!=null&&(config.size="large")),config.size&&(config.size=="medium"?(l>2&&(w=h*2+1),placeholder.addClass("app-chart-medium")):config.size=="large"&&(w=f,placeholder.addClass("app-chart-large"))),l==1&&(placeholder.addClass("app-chart-large"),w=f),config.resized?(it=placeholder,delete config.resized):config.lastScrollPosition&&(rt=placeholder,delete config.lastScrollPosition),config.ShowData||n.ChartType=="table"?n.ShowData=!0:n.ShowData&&(n.ShowData=!1),w<150&&(w=150),nt.push(inner.height(w)));if($('<div class="app-clear-fix"><\/div>').appendTo(i),setTimeout(function(){for(b in e)(n=e[b],n.ChartType&&n.RecordCount!=0)&&(n.ShowData?c(n,$(nt[ut++])):o(n,nt[ut++]))},10),u.syncEmbeddedViews(p),l==0&&a(!1),i.closest(".app-echo").length==0&&$('<div class="app-promo-filler"><\/div>').appendTo(i),t.viewProp("chartsConfig",s),l>1&&(it||rt)){var et=it||rt,st=et.outerHeight(),ht=(p.height()-st)/2,ct=et.offset().top-p.offset().top-ht;u.scroll(p,ct)}}var w=this,t=$app.find(n.id),b=t._filter,i=n.container.find(".app-chart-list"),e=n.container.data("pivots"),s=t.viewProp("chartsConfig")||{};if(i.length==0&&(i=$('<div class="app-chart-list"><\/div>').appendTo(n.container)),(n.reset||e&&t.dataSignature()!=n.container.data("signature"))&&(e=null),t._totalRowCount>__settings.maxPivotRowCount){a(!0);return}e&&e.length!=0?l():(i.find(".app-chart-inner").children().hide(),$app.execute({controller:t._controller,command:"Pivot",pivotDefinitions:t.AutoPivots,view:t._viewId,_filter:t.combinedFilter(),sort:"",tags:t.get_tags(),success:function(i){e=i.Pivots;p(e);n.container.data("signature",t.dataSignature());n.container.data("pivots",e);h?l():u.registerAPI("Charts",function(){h=!0;l()})},error:function(n){$app.alert(String.format("{0}\n{1}",n.get_message(),n.get_stackTrace()))}}))},hide:function(){},dispose:function(n){n.container.removeData("pivots signature");n.container.find("app-chart").each(function(){$(this).removeData()})}})})(),function(){function uu(){return navigator.platform.match(/Win\d+|Mac/i)!=null&&(!navigator.maxTouchPoints||navigator.maxTouchPoints==0)}function tt(n){return n&&typeof n!="string"&&!(isNaN(+n)||n<new Date(1753,0)||n>new Date(9999,0))}function it(n){navigator.vibrate&&(n||(n=50),navigator.vibrate(n))}function d(n){$('<div class="app-clear-fix"><\/div>').appendTo(n)}function fu(){if(!er){var n=new Date;er=setTimeout(function(){cr=setInterval(s,6e4)},(60-n.getSeconds())*1e3)}}function s(t,i,r){var b,e;if(t||!$(".app-calendar.app-has-time-prompt").length){var u=t||new Date,h=f(u),v=$(".app-calendar-time"),o,c=v.find("div.app-current-time"),k=l-l/25,d=u.getTime(),y=u.getMinutes(),g=new Date(u.getFullYear(),u.getMonth(),u.getDate()).getTime(),nt=d-g,a=v.find("li span"),p=u.getMinutes(),w=15e3/l;return i&&y!=0&&(h=":"+y),i?i=="week"?($(".app-calendar").addClass("app-has-time-prompt"),o=vt.activePage.find(".app-calendar-weekview .current-time-line")):o=$(".app-calendar-dayview .current-time-line"):o=$(".app-calendar-weekview .current-time-line, .app-calendar-dayview .current-time-line"),b=nt/864e5,e=k*b,i=="find"?s():c.first().css("top")!=e+"px"&&n.callInAnimationFrame(function(){h!=""&&(a.removeClass("time-hidden"),p<w?a.filter('span[data-cal-hour="'+u.getHours()+'"]').addClass("time-hidden"):p>60-w&&a.filter('span[data-cal-hour="'+(u.getHours()+1)+'"]').addClass("time-hidden"),c.text(h));c.css("top",e);o.css("top",e).data("date",u);r&&r(e)}),e}}function f(n,i,r){if(!n)return"";var u=n.getHours(),f=n.getMinutes(),h=n.getSeconds(),o=t.PMDesignator,s=t.AMDesignator,e=u<12?r?"":s:r?o.substring(0,1):o;return u>12&&(s||o)&&(u=u-12),i&&u<10&&u!=0&&(u="0"+u),u==0&&(u=o||s?12:0),f<10&&(f="0"+f),!r&&e&&(e=" "+e),r&&f=="00"?String.format("{0}{1}",u,e):String.format("{0}:{1}{2}",u,f,e)}function li(n,t,i){i<.125?n.setHours(t):i<.375?n.setHours(t,15):i<.625?n.setHours(t,30):i<.875?n.setHours(t,45):n.setHours(t,60)}function g(n){return n.getDate()==k.getDate()&&n.getMonth()==gr&&n.getFullYear()==dr}function ai(n,t){return n.getDate()==t.getDate()&&n.getMonth()==t.getMonth()&&n.getFullYear()==t.getFullYear()}function rt(n){var t;return n.each(function(){return t=$(this),firstLeft=t.position().left,firstLeft>0||firstLeft*-1<t.width()/2?!1:void 0}),t}function lt(n,t,i,r,u,f){var e=n.combinedFilter().filter(function(n){var i=n.split(":")[0];return!i.startsWith(t.Name)&&(f==null||f.indexOf(i)==-1)}),o=n.convertFieldValueToString(t,r),s=u&&n.convertFieldValueToString(t,u),h;return(h=r==null?String.format("{0}:<{1}",t.Name,s):u==null?String.format("{0}:>={1}",t.Name,o):String.format("{0}:$between${1}$and${2}",t.Name,o,s),r&&isNaN(r.getTime())||u&&isNaN(u.getTime()))?(console&&console.log&&console.log("Error forming date filter: Date is NaN"),e):(e.push(h),e)}function i(n){var r=n.attr("data-cal-year"),t=n.attr("data-cal-month"),i=n.attr("data-cal-day");return new Date(r,t?t:0,i?i:1)}function at(n,t){var i=n.attr("data-cal-h"),r=n.attr("data-cal-m"),u=n.attr("data-cal-s"),f=n.attr("data-cal-ms");t.setHours(i,r,u,f)}function dt(n,t){n.attr("data-cal-h",t.getHours()).attr("data-cal-m",t.getMinutes()).attr("data-cal-s",t.getSeconds()).attr("data-cal-ms",t.getMilliseconds())}function w(n,t){n.attr("data-cal-year",t.getFullYear()).attr("data-cal-month",t.getMonth()).attr("data-cal-day",t.getDate())}function eu(n){var i={hour:n.getHours(),minute:n.getMinutes(),ampm:""},r=!!t.AMDesignator.length;return r&&(i.ampm=i.hour>=12?t.PMDesignator:t.AMDesignator,i.hour>12&&(i.hour-=12),i.hour==0&&(i.hour=12)),i.hour=i.hour<10?" "+i.hour:i.hour.toString(),i.minute=i.minute<10?"0"+i.minute:i.minute.toString(),i}function yr(n,t,i){var o="",r=new Date(n,t,1),s=e[r.getDay()],h=new Date(n,t+1,1),l=e[h.getDay()],u="",c=0,a=0,f;for(l!=0&&h.setDate(h.getDate()+(6-l)+1),s!=0&&r.setDate(r.getDate()-s);a<42;)if(s=e[r.getDay()],s==0&&(u&&(o+=u+"<\/tr>"),c++,u="<tr>"),u+="<td",f=r.getMonth(),f==t||i?(i&&f!=t?u+=t==11&&f==0||!(t==0&&f==11||f<t)?' class="app-next-month"':' class="app-prev-month"':st.setHours(0,0,0,0)==r.setHours(0,0,0,0)&&(u+=' class="app-current-day"'),i&&(u+=String.format(' data-cal-year="{0}" data-cal-month="{1}" data-cal-day="{2}"',r.getFullYear(),r.getMonth(),r.getDate())),u+=String.format(">{0}",r.getDate())):u+=">&nbsp;",u+="<\/td>",r.setDate(r.getDate()+1),a++,!i&&r>=h)break;for(o+=u;c<6;)c++,o+="<tr><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><\/tr>";return o+""}function v(n,t){vt.activePage.find(".app-tabs .ui-btn").each(function(){var n=$(this);if(n.attr("data-text")==t.text())return n.trigger("vclick"),!1})}function ut(n,t){var r=n.find(".app-tabs a"),i;return r.each(function(){var n=$(this);if(n.attr("data-text")==t)return i=n,!1}),i}function yi(n){var s=n.get_hasParent(),h=n.get_filterFields(),o=[],i=[],r,u,f,e,t;return $(n._allFields).each(function(){var n=this,l,v;if(n.Tag)for(l=n.Tag.split(" "),v=l.length,t=0;t<v;t++){if(match=rr.exec(l[t]),match!=null){var y=match[1]?parseInt(match[1]):0,a=match[2],p=match[4],c=i[y];if(a=="disabled")break;c||(i[y]=c={});switch(a){case"date":c.date=n;break;default:c[a]=p||n}}rr.lastIndex=0}if((n.ItemsDataController||n.AliasName)&&n.ItemsStyle!="CheckBoxList"&&(s&&n.Name==h||(u?f||(f=n):u=n)),r||n.Type!="String"||(r=n),(n.Type=="DateTime"||n.Type=="Date")&&!n.tagged("calendar-disabled")){for(e||(e=n),t=0;o[t];)t++;o[t]={date:n,name:n.Label}}}),$.isEmptyObject(i)&&(i=o),$(i).each(function(){var t=this,i;!t.text&&r&&(t.text=r);!t.date&&e&&(t.date=e);t.name||(t.name=t.date.Label);u&&!t.color&&(t.color=r&&f&&r==u?f:u);i=t.color?n.viewProp("calendarColorMap-"+t.color.Name):null;t.colorMap=new ir(n,t,i)}),i}function ft(t,i){var f=n.dataView(),u=f&&f.calendar,l=f&&f.extension().viewStyle;t||(t=u.scrollable());var e=t.find('.app-presenter[data-presenter="calendar"]'),o=e.data("cal-header"),h=e.data("cal-footer"),c=u.viewClassName(),s=e.find(c);i&&(u.preventNavigate=!0,u.getViewHandler().resize(s,o,h,!0));pt&&pt();u.updateHeader(o);u.loadData(s);r("refresh",{container:n.sidebar().find(".app-calendar-plugin")})}function pr(n,t){return(t-n)/36e5*(l/25)}function wr(t){if(t.calendar)return!0;if(t._keyFields.length>1)return!1;var i=yi(t),r=n.sidebar();return $.isEmptyObject(i)?!1:(t.calendar=new wi(t,i),t.calendarPlugin||(t.calendarPlugin=new tr(t,i)),!0)}function ni(n,t,i,r){n.css({transform:"",opacity:1}).addClass("app-scale");setTimeout(function(){n.one("transitionend",function(){return n.hide(),i&&i(),t.removeClass("app-scale").show().css({transform:"scale(0.75)",opacity:0}),setTimeout(function(){t.addClass("app-scale").css({transform:"scale(1)",opacity:1}).one("transitionend",function(){t.removeClass("app-scale");r&&r()})}),!1}).css({transform:"scale(0.75)",opacity:0})})}function b(n,t){return n.find(String.format('td[data-cal-month="{0}"][data-cal-day="{1}"]:not(.app-day-hidden)',t.getMonth(),t.getDate()))}function ti(n,t){return n.find(String.format('.app-scroll-column > div[data-cal-year="{0}"][data-cal-month="{1}"]',t.getFullYear(),t.getMonth()))}function ou(t){t||(t=n.sidebar());t.find(".app-calendar-plugin").addClass("app-hide-request")}for(var vi,gt,pi,wi,bi,ki,di,gi,nr,h,r,tr,ir,br=$(window),et=$("body"),kr=et.hasClass("app-ios"),vt=$.mobile,n=$app.touch,o=Web.DataViewResources,ii=o.Pager,c=o.HeaderFilter,u=o.Presenters.Calendar,ot=o.Mobile,t=Sys.CultureInfo.CurrentCulture.dateTimeFormat,k=new Date,st=new Date(k.getFullYear(),k.getMonth(),k.getDate()),dr=k.getFullYear(),gr=k.getMonth(),rr=/calendar(\d+)?-([a-zA-Z]+)(:['"]?([a-zA-Z]+)['"]?)?(\d+)?/g,nu=/^(\d+), (\d+), (\d+)(, (.*))?$/,yt,ur,pt,ri,ui,wt,fr,er,fi,or,sr,hr,ei,cr,nt,lr,bt=500,oi=100,ht=66,si=0,l=1060,y={year:2,month:2,week:7,day:1,agenda:1},hi={year:5,month:5,week:21,day:2,agenda:90},tu=30,kt=30,iu=23,ar=5,e=[],ct=[],a,ci,vr='<a class="ui-btn app-month-picker" title="{0}, {1}">{2}, {3}<\/a>',ru='+{0} <span class="app-month-more">'+ot.More.toLowerCase()+"<\/span>",p=0;p<7;p++)e[p]=(7+p-t.FirstDayOfWeek)%7,ct[p]=(p+t.FirstDayOfWeek)%7;vi=function(n){this.calendar=n;this.data={day:{},month:{},year:{},agenda:{}}};vi.prototype={select:function(n){var t=this.calendar.mode,u=new Date(n),i,r;if(t=="week")t="day";else if(t=="agenda")return this.data[t][n];return(r=this.data[t][u.getFullYear()],!r)?null:t=="year"?r:(i=r[u.getMonth()],!i)?null:t=="month"?i:i[u.getDate()]},insert:function(n,t){var a=new Date(n),v=this.dataView,y=this.calendar.activeCalendar.date,i=this.calendar.mode,l=i=="week"?7:1,f,c,h,o,e,r,u,s;if(i=="week")i="day";else if(i=="agenda"){n<0&&t.reverse();this.data[i][n]=t;return}switch(i){case"year":this.data[i][n.getFullYear()]={};break;case"month":r=this.data[i][n.getFullYear()];r||(r=this.data[i][n.getFullYear()]={});r[n.getMonth()]={};break;case"day":for(f=new Date(n),p=0;p<l;p++)r=this.data[i][f.getFullYear()],r||(r=this.data[i][f.getFullYear()]={}),u=r[f.getMonth()],u||(u=r[f.getMonth()]={}),u[f.getDate()]={rows:[],count:0},f.setDate(f.getDate()+1)}for(c in t)(h=t[c],o=nu.exec(h[0]),o)&&(e=new Date(o[1],parseInt(o[2])-1,o[3]||o[2]),r=this.data[i][e.getFullYear()],r||(r=this.data[i][e.getFullYear()]={}),u=r[e.getMonth()],u||(u=r[e.getMonth()]={}),s=u[e.getDate()],s||(s=u[e.getDate()]={rows:[],count:0}),i=="year"?s.count=h[1]:($(h[1]).each(function(){this.length==5&&s.rows.push(this)}),s.count+=h[2]))},clear:function(){this.data={day:{},month:{},year:{},agenda:{}}},clearAgenda:function(){this.data.agenda={}}};$(document).on("scrollstart.app",function(){yt=!0}).on("scroll.app scrollstop.app resized.app",function(t){var f;yt=!1;var i=n.dataView(),r=i&&i.calendar,s=i&&i.extension().viewStyle(),u=t.type=="resized";if(i&&s=="calendar"&&r){if(f=r.mode.match(/day|week/),u&&f){var h=r.scrollable(),c=h.find('div[data-presenter="calendar"]'),e=c.data("cal-header"),o=r.getVisibleView();o&&o.removeClass("app-has-current-day");e&&e.find(".app-week-header ul, .app-day-header ul").css("visibility","hidden")}clearTimeout(ur);ur=setTimeout(function(){yt||!u&&f||ft(t.relatedTarget,u)},300)}}).on("more.app",function(t){var p=$(t.target),f=p.closest(".app-echo"),r=f.length?$app.find(f.attr("data-for")):n.dataView(),e=$.mobile.activePage.find(".app-wrapper"),o=e.find(".app-calendar"),w=t.type=="more",b=t.type=="viewselector",s;if(r&&o.length&&o.is(":visible")&&(s=r.extension().viewStyle(),s=="calendar")){var k=r.viewProp("calendarConfig"),i=k.mode,d=e.parent().find(".app-bar-calendar .app-tabs"),h={text:u.Day,icon:i=="day"?"check":!1,callback:v},c={text:u.Week,icon:i=="week"?"check":!1,callback:v},l={text:u.Month,icon:i=="month"?"check":!1,callback:v},a={text:u.Year,icon:i=="year"?"check":!1,callback:v},y={text:u.Agenda,icon:i=="agenda"?"check":!1,callback:v};w&&t.panel[0].id=="app-panel-view-options"?t.items.splice(t.items.length,0,{},h,c,l,a,y):b&&d.css("visibility")=="hidden"&&t.items.splice(0,0,h,c,l,a,y,{})}}).on("vclick contextmenu taphold",".app-calendar, .app-bar-calendar",function(r){var ti,di,st,dt,o,ai,tt,et,g,it,bi,ht;if(a||ci){a=!1;return}var f=$(r.target),ei=r.type,wt=f.closest(".app-echo"),ct=wt.length?$app.find(wt.attr("data-for")):n.dataView(),e=ct.calendar,b=$.mobile.activePage.find(".app-wrapper"),ft=b.find('.app-presenter[data-presenter="calendar"]'),h=f.closest(".ui-btn"),bt=f.parent(),ni=f.attr("data-cal-hour"),ki,er=n.lastTouch();if(ct&&ct.calendar&&(ki=ct._lookupInfo,!(f.closest(".app-tabs ul").length>0))){if(h.length||(h=f.find(".ui-btn")),f.is("ul")&&!!bt.attr("data-cal-day"))f=bt;else if(bt.is(".app-event"))f=bt;else if(f.is(".app-tabs"))return!1;if((ei!="taphold"||f.is(".app-event"))&&(ei!="contextmenu"||f.is("td,.app-event")||ni!=null)){if(ti=f.data("data-context"),di=f.data("data-more-context"),f.is(".dv-load-at-top, .dv-load-at-bottom, .app-btn-next, .app-btn-prev")){var nt=e.getBlocks(b),w,tt,kt=wt.length?0:hi[e.mode],p=e.views[e.mode];if(f.is(".dv-load-at-top, .app-btn-prev")){nt.length>kt&&(e.mode=="agenda"?p.removeData(b.find(".app-calendar-agendaview"),p.maxPage):nt.slice(kt).remove());var ot=nt.first(),k,ii=0,tt=Number(ot.data("cal-year")),it=ot.data("cal-month")!=null?Number(ot.data("cal-month")):1,gi=b.scrollTop(),oi=f.outerHeight(!0)-b.find(".app-presenter-instruction").outerHeight(!0),si=[];for(w=i(ot),st=0;st<y[e.mode];st++){switch(e.mode){case"month":w.setMonth(w.getMonth()-1);k=p.drawMonth(w);break;case"year":w.setFullYear(tt-1);tt=w.getFullYear();k=p.drawYear(w);oi+=-6;break;case"agenda":f.text(c.Loading);p.loadData(b.find(".app-calendar-agendaview"),null,p.minPage-1)}k&&(k.insertBefore(ot),ot=k,si.push(k))}p.resize(e.getVisibleView());$(si).each(function(){ii+=$(this).outerHeight(!0)});ii&&n.scroll(b,Math.ceil(gi+ii+oi))}else{var lt=nt.last(),k,tt=Number(lt.data("cal-year")),it=lt.data("cal-month")!=null?Number(lt.data("cal-month")):1,w=new Date(tt,it);for(nt.length>kt&&(e.mode=="agenda"?p.removeData(b.find(".app-calendar-agendaview"),p.minPage):(nt.slice(0,nt.length-kt).remove(),dt=0,nt.each(function(){dt+=$(this).height()}),n.scroll(b,dt-1))),st=0;st<y[e.mode];st++){switch(e.mode){case"month":w.setMonth(w.getMonth()+1);k=p.drawMonth(w);break;case"year":w.setFullYear(tt+1);tt=w.getFullYear();k=p.drawYear(w);break;case"agenda":f.text(c.Loading);p.loadData(b.find(".app-calendar-agendaview"),null,p.maxPage+1)}k&&(k.insertAfter(lt),lt=k)}p.resize(e.getVisibleView())}return!1}if(ti)return e.selectEvent(ti,f,r),r.preventDefault(),!1;if(f.is(".app-event-more")){if(!e.hasKeyFields())return!1;o=i(f.closest(".app-calendar-day"));ai=f.data("data-more-context");e.showEventList(o,ai,f,r)}else if(f.closest(".app-calendar-month-more").length){if(!e.hasKeyFields())return!1;var vi=f.closest(".app-calendar-month-more"),at=f.closest("td"),nr=at.find(".app-event"),yi=[],it=f.closest(".app-calendar-month"),d=at.attr("data-cal-day"),ri=i(it);ri.setDate(d);nr.each(function(){var n=$(this),t=n.data("data-context");yi.push(t[0])});function pi(n){n=n.filter(function(n){return yi.indexOf(n[0])==-1});e.showEventList(ri,n,f,r)}vi.addClass("ui-btn-active");n.callWithFeedback(at,function(){vi.removeClass("ui-btn-active");var n=at.data("data-more-context");n?pi(n):e.requestData({mode:"daylist",date:ri,success:function(t){t.Pivots.pivot0&&t.Pivots.pivot0.Data[1]&&(n=t.Pivots.pivot0.Data[1][1],at.data("data-more-context",n),pi(n))}})})}else{if(f.closest(".app-day-header").length){if(f.is("ul"))return;var ui=ft.find(".app-calendar-dayview"),et=h.closest(".app-day-header"),tr=ft.data("cal-footer");return n.callWithFeedback(h,function(){var f=ft.data("cal-footer").find(".app-scroll-outer"),r=h.closest("li"),n=i(r),o=n.getFullYear(),s=n.getMonth(),c=n.getDate(),t=e.getBlockByDate(ui,n,"day"),u=parseInt(ui.css("marginLeft"),10)-t.position().left;t.length&&e.views.day._scroll(ui,et,u*-1,tr,!0)}),!1}if(f.closest(".app-week-header").length)return f.is("ul")?void 0:(n.callWithFeedback(h,function(){var n=ut(f.closest(".app-bar-calendar"),u.Day),t=i(h.closest("li"));e.navigateDate=t;n&&n.trigger("vclick")}),!1);if(f.is(".ui-btn")||f.closest(".ui-btn").length){if(h.is(".app-calendar-today,.app-calendar-next,.app-calendar-prev"))return n.callWithFeedback(h,function(){if(b.length>0){var t=h.is(".app-calendar-next"),i=h.is(".app-calendar-prev"),n="today";t?n="next":i&&(n="prev");e.scrollView(n)}}),!1;if(h.is(".app-calendar-badge")){var vt=ct.viewProp("calendarConfig"),yt=vt.mode,ir=b.parent().find(".app-bar-calendar .app-tabs");ir.css("visibility")=="hidden"?n.callWithFeedback(h,function(){n.listPopup({anchor:h,iconPos:"left",items:[{text:u.Day,icon:yt=="day"?"check":!1,callback:v},{text:u.Week,icon:yt=="week"?"check":!1,callback:v},{text:u.Month,icon:yt=="month"?"check":!1,callback:v},{text:u.Year,icon:yt=="year"?"check":!1,callback:v},{text:u.Agenda,icon:yt=="agenda"?"check":!1,callback:v}]})}):n.callWithFeedback(h,function(){n.listPopup({anchor:h,title:h.attr("data-cal-value")})})}else if(h.is(".app-calendar-month-header")){o=null;et=ft.data("cal-header");g=ut(et,u.Month);switch(e.mode){case"year":tt=f.closest(".app-calendar-year").attr("data-cal-year");it=f.closest(".app-calendar-month").attr("data-cal-month");o=new Date(tt,it);break;case"agenda":o=i(h)}if(o)return e.navigateDate=o,n.callWithFeedback(h,function(){g&&g.trigger("vclick")}),!1}else if(h.parent().attr("data-cal-day")||f.is("h2")){if(e.mode=="month"){if(f.is("td"))return;var et=ft.data("cal-header"),it=f.closest(".app-calendar-month"),g=ut(et,u.Day);return o=i(it),o.setDate(h.parent().attr("data-cal-day")),e.navigateDate=o,n.callWithFeedback(h,function(){g&&g.trigger("vclick")}),!1}e.mode!="agenda"||wt.length||(o=i(f.closest("li")),o&&(et=ft.data("cal-header"),g=ut(et,u.Day),e.navigateDate=o,n.callWithFeedback(h,function(){g&&g.trigger("vclick")})))}}else if(f.is("td")||f.is("div")&&ni!=null){if(e.mode=="year"){if(f.height()<20&&!uu())f.closest(".app-calendar-month").find(".app-calendar-month-header").trigger("vclick");else{if(d=parseInt(f.text(),10),!d)return;var tt=f.closest(".app-calendar-year").attr("data-cal-year"),it=f.closest(".app-calendar-month").attr("data-cal-month"),et=ft.data("cal-header"),g=ut(et,u.Day);e.navigateDate=new Date(tt,it,d);f.addClass("ui-btn-active");n.callWithFeedback(f,function(){g&&g.trigger("vclick");f.removeClass("ui-btn-active")})}return!1}vt=e.activeCalendar;o=null;var fi=e.getActionsByName("New"),rt,or=$(".app-calendar"),gt=!!vt.end,wi=e.mode=="month",pt;if(!fi.length)return;if(wi){if(d=f.attr("data-cal-day"),it=f.closest("div.app-calendar-month"),!d)return;o=i(it);o.setDate(d);gt&&(rt=new Date(o),rt.setMinutes(rt.getMinutes()+60))}else{d=f.closest("div.app-calendar-day");var rr=d.find(".app-calendar-eventlist"),ur=r.clientY-f.offset().top,dt=f.height(),fr=ur/dt;o=i(d);li(o,ni,fr);gt&&(rt=new Date(o),rt.setMinutes(rt.getMinutes()+60));pt=e.drawEvent([null,o,rt,null," "],null).removeClass("app-event-color-0").addClass("app-event-new");gt&&pt.height(l/25);bi=s(o,"find");pt.css("top",bi+22).appendTo(rr)}return o?(fi.forEach(function(n){var t=n.callback;n.callback=function(){$app.newValues=[{name:vt.date.Name,value:o}];gt&&$app.newValues.push({name:vt.end.Name,value:rt});t(arguments)}}),ht={iconPos:"left",items:fi,title:String.format("{0:"+t.LongDatePattern+"} {0:"+t.ShortTimePattern+"}",o),afterclose:function(){pt&&pt.remove()}},wi?ht.anchor=f:(ht.x=r.pageX,ht.y=r.pageY,ht.arrow="b,t,l,r"),n.listPopup(ht),!1):void 0}}}}}).on("clear.dataview.app",function(n){var t=n.dataView,i=t.calendar;i&&$("#"+t._id).find(".app-calendar-selected").removeClass("app-calendar-selected")}).on("reset.dataview.app",function(t){var i=t.dataView,f,e;if(i){var r=i.calendar,o=i&&i.extension()&&i.extension().viewStyle(),u=i.calendarPlugin;if(r&&(r.clear(),r.activeCalendar.colorMap.clearFilter()),u){if(f=i&&i.get_viewType(i._id),e=i.get_master(),e&&!i.get_selectedKey().length)return;f&&f=="Grid"&&(u.filtering||(u.clearCache(),n.stickyHeaderBar().hide()))}}}).on("show.dataview.app",function(t){var i=t.dataView,r=i&&i.get_viewType(i._id),u=n.sidebar();if(!i||r!="Grid"){ou(u);return}if(wr(i))r&&r=="Grid"&&(i.calendar&&i.calendar.loadData(i.calendar.getVisibleView()),i.calendarPlugin&&i.calendarPlugin.attach(u));else return});gt={options:{dataView:!0},start:function(n){var t,i;if(n.dir="horizontal",t=n.dataView.calendar,i=t.getViewHandler(),this._calendar=t,this._handler=i,i._scroll){var r=t.getVisibleView(),u=r.closest(".app-presenter"),f=u.data("cal-header").find(".app-"+t.mode+"-header"),e=u.data("cal-footer");this._calView=r;this._calHeader=f;this._calFooter=e.css("visibility","hidden");this._startMarginLeft=parseInt(r.css("margin-left"),10)}this._startX=n.x;this.scrollingAnimationFrame=null},move:function(n){var t=this;if(t._startMarginLeft!=null){var u=n.target,i=n.x-t._startX,r=t._startMarginLeft+i;t.scrollingAnimationCallback=function(){a=!0;t._handler._scroll(t._calView,t._calHeader,-r,t._calFooter);t.scrollingAnimationCallback!=null&&(t.scrollingAnimationFrame=requestAnimationFrame(t.scrollingAnimationCallback))};t.scrollingAnimationFrame==null&&(t.scrollingAnimationFrame=requestAnimationFrame(t.scrollingAnimationCallback))}},end:function(){this.scrollingAnimationCallback=null;this._calFooter&&this._calFooter.css("visibility","")},cancel:function(){this.scrollingAnimationCallback=null;this._calFooter&&this._calFooter.css("visibility","")}};$app.dragMan.calendar=gt;$app.dragMan["calendar-bar-week"]=gt;$app.dragMan["calendar-bar-day"]=gt;pi={options:{dataView:!0},start:function(t){var o;t.dir="all";var s=t.dataView,r=t.target,u=s.calendar,h=u.scrollable(),i=r.closest(".app-event"),c=r.is(".app-event-handle"),f=i.data("data-context"),e=i.position();f&&(this._element=i,this._oldHeight=i.outerHeight(),this._oldTop=e.top,this._context=f,this._startX=t.x,this._startY=t.y,this._mode="move",this._hasMoved=!1,this._hasScrolled=!1,u.mode.match(/day|week/)?(o=h.find(".app-presenter-instruction"),this._diffY=o.height()-e.top,c&&(this._mode="resize",this._diffY-=r.position().top,a=!0)):this._placeholder=$('<span style="display:none"><\/span>').insertAfter(i));n.stickyHeaderBar().hide().addClass("app-disabled")},move:function(t){var v,st,lt,d,tt,b,it;et.css("pointer-events","");var rt=this,ut=t.dataView,o=ut&&ut.calendar,gt=t.target,h=$(t.dropTarget),ni=this._context[1],r=o.scrollable(),c=this._element;this._hasMoved||(this._hasMoved=!0,this._element.addClass("app-event-preview"));switch(o.mode){case"day":case"week":if(h=h.closest(".app-calendar-day,.current-time-line"),h.length){canDrag=!0;var u=h.is(".current-time-line")?h.data("date"):i(h),vt=t.y-this._startY-this._diffY,yt=l/25,a=vt/yt,ft=r.position();if(!ui){var k=t.x-ft.left-60,ot=r.width()-k-60,pt=k<20||ot<20;k<20?o.scrollView("prev"):ot<20&&o.scrollView("next");pt&&(this._hasScrolled=!0,ui=setTimeout(function(){ui=null},1e3))}if(ri||(ri=setTimeout(function(){ri=null;var f=r.scrollTop(),u=t.y-ft.top,e=r.height()-u,i;if(u<20){if(i=20-u,f<i)return;rt._diffY+=i;n.scroll(r,r.scrollTop()-i)}else if(e<20){if(i=20+e,f>=r[0].scrollHeight-r.height()-i)return;rt._diffY-=i;n.scroll(r,r.scrollTop()+i)}},20)),a>23.75?a=23.75:a<0&&(a=0),v=Math.floor(a),st=a-v,v!=null&&(li(u,v,st),!this._previewDate||u.getTime()!=this._previewDate.getTime())){var wt=o.mode=="week"?"week":"find",bt=s(u,wt)+22,kt=o.getVisibleView(r),ht=o.getBlockByDate(kt,u);if(ht.length){var e=this._context[1],ct=this._context[2],y=new Date(e),p,w;y.setMinutes(y.getMinutes()+30);this._mode=="resize"?(u.setFullYear(e.getFullYear(),e.getMonth(),e.getDate()),u<y&&(u=y),p=f(e,!1)+" - "+f(u,!1),w=f(e,!1)+" - "+f(u,!1),c.css("height",pr(e.getTime(),u.getTime()))):(p=f(u,!1,!0),w=f(u),ct&&(lt=ct.getTime()-e.getTime(),d=new Date(u.getTime()+lt),p+=" - "+f(d,!1),w+=" - "+f(d,!1)),c.css("top",bt),c.appendTo(ht.find(".app-calendar-eventlist")));c.find(".app-event-time").text(p);c.find(".app-event-time-long").text(w);this._previewDate=u}}}break;case"month":var g=h.closest("td"),dt=g.closest(".app-calendar-month"),nt=i(dt),at=g.attr("data-cal-day");at&&(nt.setDate(at),tt=g.find("ul"),tt.length&&(!this._previewDate||nt.getTime()!=this._previewDate.getTime())&&(this._previewDate=nt,c.appendTo(tt)));b=t.y-r.position().top;it=r.height()-b;fi||(fi=setTimeout(function(){fi=null;var t=r.scrollTop();n.desktop()&&(b<20?n.scroll(r,r.scrollTop()-(20-b)):it<20&&n.scroll(r,r.scrollTop()+(20+it)))},20));break;case"year":case"agenda":return}},end:function(n){var ut=n.target,u=n.dataView,e=u&&u.calendar,tt=e.scrollable(),p,d,c,w,a,g,b,nt;if(u._keyFields.length){var k=e&&e.activeCalendar,v=this._context,r=v[1],t,y=v[2],f,o=$(n.dropTarget);switch(e.mode){case"day":case"week":if(o=o.closest(".app-calendar-day,.current-time-line"),o.length){t=o.is(".current-time-line")?o.data("date"):i(o);var it=n.y-this._startY-this._diffY,rt=l/25,h=it/rt;h>23.75?h=23.75:h<0&&(h=0);p=Math.floor(h);d=h-p;li(t,p,d);this._mode=="resize"&&(t.setFullYear(r.getFullYear(),r.getMonth(),r.getDate()),f=t,t=r,c=new Date(r),c.setMinutes(c.getMinutes()+30),f<c&&(f=c))}break;case"month":w=$(event.target).closest("td");a=w.closest(".app-calendar-month");a.length&&(t=new Date(r),t.setYear(a.attr("data-cal-year")),t.setMonth(a.attr("data-cal-month")),t.setDate(w.attr("data-cal-day")),t.getDate()==r.getDate()&&t.getMonth()==r.getMonth()&&(t=null));this._placeholder.remove();break;case"year":case"agenda":return}t&&(g=u._keyFields[0].Name,b=[{field:g,value:v[0]},{field:k.date.Name,oldValue:r,newValue:t}],(y||f)&&(f||(nt=y.getTime()-r.getTime(),f=new Date(t.getTime()+nt)),b.push({field:k.end.Name,oldValue:y,newValue:f})),e.preventNavigate=!0,$app.execute({command:"Update",controller:u._controller,view:u._viewId,values:b,success:function(){e.lastScrollTop=tt.scrollTop();u.sync()},error:function(n){$app.alert(String.format("{0}",n.get_message()))}}));$(".app-calendar").removeClass("app-has-time-prompt");setTimeout(s,oi*2)}},cancel:function(t){var u=t.target,i=t.dataView.calendar,r;Math.abs(t.x-this._startX)<5&&u.trigger("vclick");this._hasMoved&&this._element.removeClass("app-event-preview");i.mode.match(/day|week/)?(r=i.getBlockByDate(i.getVisibleView(),this._context[1]),r.length?this._element.appendTo(r.find("ul")):this._element.remove()):(this._hasMoved&&this._element.insertAfter(this._placeholder),this._placeholder.remove());$(".app-calendar").removeClass("app-has-time-prompt");setTimeout(s,oi*2);this._element.css({height:this._oldHeight,top:this._oldTop});n.stickyHeaderBar().removeClass("app-disabled");i.preventNavigate=!0}};$app.dragMan["calendar-event"]=pi;$app.dragMan["calendar-event-handle"]=pi;wi=function(n,t){var i=this,r;i.dataView=n;r=n.viewProp("calendarConfig")||{};r.mode||(r.mode=$(document).width()<768?"day":"week");i.mode=r.mode;i.calendars=t;r.activeCalendar&&$(t).each(function(){if(this.name==r.activeCalendar)return i.activeCalendar=this,!1});i.activeCalendar||(i.activeCalendar=t[Object.keys(t)[0]]);i.cache=new vi(i);i.views={day:new bi(i),week:new ki(i),month:new di(i),year:new gi(i),agenda:new nr(i)};n.viewProp("calendarConfig",r)};wi.prototype={scrollable:function(){var t=this,n=t._scrollable;return n||(n=t._scrollable=$("#"+this.dataView._id+" .app-wrapper")),n},viewClassName:function(){return String.format(".app-calendar-{0}view",this.mode)},show:function(t){var f=this,h=this.dataView,et=h._filter,c=t.container.closest(".app-echo").length>0,l=t.container.find(".app-calendar"),y=t.container.closest(".app-wrapper"),ot=t.container.data("pivots"),d=this.calendars,p=h.viewProp("calendarConfig"),g=this.activeCalendar.colorMap,e,tt,s,a,w,b,o,k,v,it;if(!$.isEmptyObject(d)){if(!c&&this.lastScrollTop&&y.scrollTop()==0&&n.scroll(y,this.lastScrollTop),c?(this.mode="agenda",this.echoMaxHeight=t.maxHeight,p.mode="agenda",h.viewProp("calendarConfig",p)):p.mode&&(this.mode=p.mode),w=this.getViewHandler(),this.navigateDate||this.preventNavigate||(b=h.extension().commandRow(),b&&this.activeCalendar.date?(this.enhancePrecision=!0,this.navigateDate=b[this.activeCalendar.date.Index]):this.navigateDate=new Date),l.length>0){if(o=t.container.find(".app-calendar > div:visible"),!c)if(e=t.container.data("cal-header"),s=t.container.data("cal-footer"),w.showHeaderAndFooter(e,s),$app.touch.bar("show",e),g.show(),o.is(f.viewClassName())){if(this.navigateDate&&!this.preventNavigate){if(a=this.getBlockByDate(o,this.navigateDate),a&&a.length&&!c){this.scroll({view:o,enhancePrecision:!0});return}this.animate=!1}}else o.hide()}else if(l=$('<div class="app-calendar" data-draggable="calendar"><\/div>').appendTo(t.container),!c){e=$('<div class="app-bar-calendar"><\/div>').appendTo($app.touch.bar("create",{type:"header",page:t.container}));tt=$('<div class="app-calendar-badge ui-btn"><\/div>').appendTo(e);$app.touch.tabs("create",{container:$('<div class="app-tabs"><\/div>').appendTo(e),tabs:[{text:u.Day,value:"day",selected:this.mode=="day"},{text:u.Week,value:"week",selected:this.mode=="week"},{text:u.Month,value:"month",selected:this.mode=="month"},{text:u.Year,value:"year",selected:this.mode=="year"},{text:u.Agenda,value:"agenda",selected:this.mode=="agenda"}],change:function(u){var o=f.mode,c=f.getMostVisibleBlock(y,o),e=c&&i(c),s=!1,l=h.viewProp("calendarConfig"),a=h.calendarPlugin;if(l.mode=u.value,h.viewProp("calendarConfig",l),!f.navigateDate){if(f.lastDate)switch(o){case"year":f.lastDate.getFullYear()==e.getFullYear()&&(s=!0);break;case"month":f.lastDate.getFullYear()==e.getFullYear()&&f.lastDate.getMonth()==e.getMonth()&&(s=!0)}f.navigateDate=s?f.lastDate:e;f.enhancePrecision=!0}o.match(/week|day/)&&(f.lastDayScrollTop=y.scrollTop());t.container=t.container.closest(".app-wrapper");t.container.focus();f.navigateDate&&isNaN(f.navigateDate.getTime())&&(alert("navigate date is NaN"),f.navigateDate=new Date);n.presenter("show",t);r("refresh",{container:n.sidebar().find(".app-calendar-plugin")})},restoreScrolling:!1,stickyHeader:!0});t.container.data("cal-header",e);$('<a class="ui-btn ui-btn-icon-notext ui-icon-carat-l ui-corner-all app-calendar-prev"><\/a>').attr("title",ii.Previous).appendTo(e);$('<a class="ui-btn ui-btn-icon-notext ui-icon-carat-r ui-corner-all app-calendar-next"><\/a>').attr("title",ii.Next).appendTo(e);k=$('<a class="ui-btn ui-btn-icon-notext ui-icon-calendar ui-corner-all app-calendar-today"><\/a>').attr("title",u.Today);k.appendTo(e);s=$('<div class="app-bar-calendar-footer"> <\/div>').appendTo($app.touch.bar("create",{type:"footer",page:t.container}));v=$('<div class="app-scroll-outer app-bar-system"><\/div>').insertBefore(s.contents().first());it=$('<div class="app-scroll-inner"><\/div>').appendTo(v);v.on("scroll",function(){var n;if(v.data("resizing")){v.removeData("resizing");return}if(n=f.mode,n.match(/day|week/)){var t=v.scrollLeft(),i=f.viewClassName(),r=".app-"+n+"-header",u=nt==null;nt=function(){f.views[n]._scroll(y.find(i),e.find(r),t,s);nt!=null&&requestAnimationFrame(nt)};u&&requestAnimationFrame(nt)}}).on("scrollstop",function(){clearTimeout(lr);lr=setTimeout(function(){nt=null},400)});this.mode.match(/day|week/)&&$app.touch.bar("show",s);t.container.data("cal-footer",s);fu()}this.activeCalendar.end?l.addClass("app-calendar-has-end-time"):l.removeClass("app-calendar-has-end-time");var rt=String.format("app-calendar-{0}view",this.mode),ut=String.format(".app-{0}-header",this.mode),o=l.find("."+rt),ft=c?null:e.find(ut);this.navigateDate&&!this.preventNavigate&&(a=this.getBlockByDate(o,this.navigateDate));o.length>0&&(this.preventNavigate||this.navigateDate&&a&&a.length)?(o.is(":visible")||o.fadeIn("fast"),w.resize(o,ft,s)):o=w.draw(l,this.navigateDate);c||($app.touch.bar("show",e),f.updateHeader(e));this.resetVars()}},scroll:function(n){n.view||(n.view=this.getVisibleView());n.preventNavigate==null&&(n.preventNavigate=this.preventNavigate);n.enhancePrecision==null&&(n.enhancePrecision=this.enhancePrecision);n.animate==null&&(n.animate=this.animate);n.date==null&&(n.date=this.navigateDate);this.getViewHandler().scroll(n);this.resetVars()},hide:function(t){var u=n.dataView(),s=u&&u.extension().viewStyle(),i=this.scrollable();if(i&&(this.lastScrollTop=i.scrollTop()),s!="calendar"){var f=t.container.data("cal-header"),e=t.container.data("cal-footer"),o=n.sidebar(),h=o.find(".app-calendar-color-legend"),c=i.find('.app-presenter[data-presenter="calendar"]');f&&$app.touch.bar("hide",f);e&&$app.touch.bar("hide",e);r("refresh",{container:o.find(".app-calendar-plugin")});this.activeCalendar.colorMap.hide()}},dispose:function(n){var i=n.container.data("cal-header"),t=this.dataView,r,u;i&&(i.off(),$app.touch.tabs("destroy",{container:i}),$app.touch.bar("remove",i));r=n.container.data("cal-footer");r&&(r.off(),$app.touch.bar("remove",r));n.container.removeData();clearInterval(cr);this.cache.clear(n.container);t.calendar.activeCalendar.colorMap.clearFilter();for(u in this.views)this.views[u].calendar=null;t.calendar=null;t.calendarPlugin.calendar=null;t.calendarPlugin.dataView=null;t.calendarPlugin=null;this.dataView=null;this._scrollable=null},selectEvent:function(t,i,r){function b(t){var r=!1,h=i.is(".app-calendar-selected"),o=n.pageInfo(u._id);a=e=="taphold";s||(o.echoChanged=!0);a||e=="vclick"&&d?(r=!0,t&&(i.removeClass("app-calendar-selected"),u.extension().clearSelection())):e=="contextmenu"&&(n.contextScope(u._id),n.rowContext(i,{x:c,y:l}),n.contextScope(null),r=!0);n.refreshEchoToolbarWithDelay(u,f);r||(n.contextScope(u._id),n.cardPopup({anchor:i,x:c,y:l,dataView:u}),n.contextScope(null))}function k(t){function r(n){var t=n.data("data-context");if(t&&t[h.Name]==w)return n.addClass("app-calendar-selected"),!1}u.extension().tap({row:t},y?"select":"none");v.find(".app-calendar-selected").removeClass("app-calendar-selected");f.find(".app-calendar-selected").removeClass("app-calendar-selected");s?v.find(o.viewClassName()+" .app-event").each(function(){r($(this))}):i.closest(".app-event, .app-calendar-month-more").addClass("app-calendar-selected");f.length&&f.find(".app-event").each(function(){r($(this))});y||(b(!1),n.refreshEchoToolbarWithDelay(u,f))}var e=r.type,d=r.ctrlKey,c=r.pageX,l=r.pageY,v=this.scrollable(),o=this,u=o.dataView,y=u._lookupInfo,s=i.closest(".app-echo").length;if(this.hasKeyFields()){var h=this.dataView._keyFields[0],p=this.getCurrentKey(),w=this.mode!="agenda"&&!s?t[0]:t[h.Name],f=$("#"+u._id+"_echo");if(u._keyFields.length==1){if(ci)return;n.clearHtmlSelection();p!=null&&w==p?b(!0):o.mode=="agenda"?k(t):$app.execute({controller:u._controller,view:u._viewId,filter:[{field:h.Name,operator:"=",value:t[0]}],sort:"",success:function(n){ci||k(n[u._controller][0])},error:function(n){$app.alert(String.format("{0}",n.get_message()))}});i.addClass("ui-btn-active");n.callWithFeedback(i,function(){i.removeClass("ui-btn-active")})}}},showEventList:function(i,r,u,f){var e=this,s=e.getCurrentKey(),o=[];r.forEach(function(n){var t=n[0],i=n[1],r=n[2],c=n[3],h=n[4];o.push({text:e.getEventTitle(i,r,h,""),color:e.activeCalendar.colorMap.color(n[3]),visible:t==s?!0:!1,callback:function(){e.selectEvent(n,u,f)}})});n.listPopup({title:String.format("{0:"+t.LongDatePattern+"}",i),anchor:u,iconPos:"left",items:o})},getViews:function(){return $("#"+this.dataView._id).find('.app-wrapper .app-presenter[data-presenter="calendar"] > div.app-calendar > div')},getVisibleView:function(){return this.scrollable().find('.app-presenter[data-presenter="calendar"] > div.app-calendar > div.app-calendar-'+this.mode+"view")},getViewHandler:function(){return this.views[this.mode]},resetVars:function(){this.preventNavigate=null;this.lastDate=this.navigateDate;this.navigateDate=null;this.enhancePrecision=null;this.animate=null},clear:function(n){var t=this.getVisibleView(),i;this.cache.clear();for(i in this.views)this.views[i].clear(i==this.mode?n:!1);t&&t.length&&(this.loadData(t),this.dataView.calendarPlugin&&this.dataView.calendarPlugin.clearCache())},drawDayColumns:function(n,t,i){for(var u,f,o="",r=new Date(n.getFullYear(),n.getMonth(),n.getDate()),s=0;s<t;s++)u='<div data-cal-year="'+r.getFullYear()+'" data-cal-month="'+r.getMonth()+'" data-cal-day="'+r.getDate()+'" class="app-calendar-day',g(r)&&(u+=" current-day-column"),e[r.getDay()]==6&&(u+=" endofweek"),u+='">',f="",i&&(f+=this.drawTimeColumn(n)),f+='<div data-cal-hour="0"><\/div><div data-cal-hour="0"><\/div><div data-cal-hour="1"><\/div><div data-cal-hour="2"><\/div><div data-cal-hour="3"><\/div><div data-cal-hour="4"><\/div><div data-cal-hour="5"><\/div><div data-cal-hour="6"><\/div><div data-cal-hour="7"><\/div><div data-cal-hour="8"><\/div><div data-cal-hour="9"><\/div><div data-cal-hour="10"><\/div><div data-cal-hour="11"><\/div><div data-cal-hour="12"><\/div><div data-cal-hour="13"><\/div><div data-cal-hour="14"><\/div><div data-cal-hour="15"><\/div><div data-cal-hour="16"><\/div><div data-cal-hour="17"><\/div><div data-cal-hour="18"><\/div><div data-cal-hour="19"><\/div><div data-cal-hour="20"><\/div><div data-cal-hour="21"><\/div><div data-cal-hour="22"><\/div><div data-cal-hour="23"><\/div><div data-cal-hour="0"><\/div><ul class="app-calendar-eventlist"><\/ul><div class="app-clear-fix"><\/div>',u+=f+"<\/div>",o+=u,r.setDate(r.getDate()+1);return o},drawDayHeaders:function(n,i){for(var u="",r=new Date(n.getFullYear(),n.getMonth(),n.getDate()),f=0;f<i;f++){var o=e[r.getDay()],s=t.DayNames[r.getDay()],h=t.AbbreviatedDayNames[r.getDay()];u+='<li  data-cal-year="'+r.getFullYear()+'" data-cal-month="'+r.getMonth()+'" data-cal-day="'+r.getDate()+'" class="';o==0&&(u+=" first-day-of-week");o==6&&(u+=" last-day-of-week");u+='"><a class="ui-btn" title="'+s+'"><span class="letter-day">'+h.substring(0,1)+'<\/span><span class="abbr-day">'+h+'<\/span><span class="full-day">'+s+"<\/span>&nbsp;<div";g(r)&&(u+=' class="app-current-day"');u+=">"+r.getDate()+"<\/div><\/a><\/li>";r.setDate(r.getDate()+1)}return u},drawTimeColumn:function(){for(var r,f,e='<div class="app-calendar-time"><ul>',i,o=!!t.AMDesignator.length,n=0;n<=24;n++)o?n==12?i=u.Noon:(r=n%12,f=n<12?t.AMDesignator:t.PMDesignator,(n==0||n==24)&&(r=12,f=t.AMDesignator),i=String.format("{0} {1}",r,f)):i=n==24?0:n,e+='<li><span data-cal-hour="'+n+'">'+i+"<\/span><\/li>";return e+'<\/ul><div class="app-current-time"><\/div><\/div>'},getBlocks:function(){return this.getViewHandler().getBlocks()},getMostVisibleBlock:function(n){var t,r,i,u;n||(n=this.scrollable());r=n.height()/2;i=$(this.getBlocks(n));switch(this.mode){case"day":case"week":if(i.each(function(){var n=$(this);if(t||(t=n),n.position().left>n.width()/2)return!1;t=n}),this.mode=="week")while(t&&t.length&&t.position().left+t.width()<=ht)u=t.next(),t=u;break;case"year":case"month":case"agenda":i.each(function(){var n=$(this);return t=n,n.offset().top+n.height()>r?!1:void 0})}return t},getFirstVisibleBlock:function(t){var u,f;t||(t=this.scrollable());var e=n.stickyHeaderBar().outerHeight()+t.offset().top,r=$(this.getBlocks(t)),i=r.eq(0),o=i.width(),s=this.getVisibleView(),h=parseInt(s.css("marginLeft"),10);switch(this.mode){case"day":case"week":u=Math.floor(-h/o);i=r.eq(u);i&&i.length&&i.position().left<0&&(f=r.eq(u+1),f.length&&(i=f));break;case"month":case"year":case"agenda":r.each(function(){var n=$(this);if(n.offset().top>e)return!1;i=n})}return i},getLastVisibleBlock:function(n){var t,r=n.height()+n.position().top,u=n.width(),i=$(this.getBlocks(n));switch(this.mode){case"day":case"week":i.each(function(){var n=$(this);if(t||(t=n),n.position().left>=u)return!1;t=n});break;case"month":case"year":case"agenda":i.each(function(){var n=$(this);if(t||(t=n),n.offset().top>r)return!1;t=n})}return t},getBlockByDate:function(n,t){var i=t.getFullYear(),r=t.getMonth(),u=t.getDate();if(!n||!n.length)return null;switch(this.mode){case"year":return n.find(String.format('.app-calendar-year[data-cal-year="{0}"]',i));case"month":return n.find(String.format('.app-calendar-month[data-cal-year="{0}"][data-cal-month="{1}"]',i,r));case"week":case"day":return n.find(String.format('.app-calendar-day[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"]',i,r,u));case"agenda":return n.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"] ul',i,r,u))}},resizeScroller:function(n,t,i){var r=t.find(".app-scroll-outer"),u=parseInt(n.css("marginLeft"),10)*-1;i&&r.find(".app-scroll-inner").css("width",i);r.scrollLeft(u).data("resizing",!0)},updateHeader:function(n){var r=this;ei||(ei=setTimeout(function(){var v=r.scrollable(),at=r.mode,et=n.find(".app-tabs"),ot=et.css("visibility")!="hidden",y=r.getFirstVisibleBlock(v),l,ut,ft;if(y){var c=n.find(".app-calendar-badge"),e=i(y),u=e.getFullYear(),w=e.getMonth(),vt=e.getDay(),o=e.getDate(),s=t.MonthNames[w],h=t.AbbreviatedMonthNames[w],yt=ot?et.find("ul").offset().left-c.offset().left:n.find("a.app-calendar-today").offset().left,st=1,f=[];switch(at){case"year":f=["<b>"+u+"<\/b>&nbsp;"];l=y.find("h1");l.is("app-in-header")||(v.find(".app-calendar-yearview .app-calendar-year h1.app-in-header").removeClass("app-in-header"),l.addClass("app-in-header"));break;case"month":f=[String.format("<b>{0}<\/b> {1}",s,u),String.format("<b>{0}<\/b> {1}",h,u),String.format("<b>{0}<\/b>",s),String.format("<b>{0}<\/b>",h)];l=y.find("h1.app-calendar-month-header");l.is("app-in-header")||(v.find(".app-calendar-monthview .app-calendar-month h1.app-calendar-month-header.app-in-header").removeClass("app-in-header"),l.addClass("app-in-header"));break;case"week":var b=r.getLastVisibleBlock(v),k=b?i(b):new Date,d=k.getFullYear(),g=k.getMonth(),a=k.getDate(),p=w==g,nt=u==d,tt=t.MonthNames[g],it=t.AbbreviatedMonthNames[g];if(!b)return;f.push(String.format("<b>{0} {1}<\/b>{2} - <b>{3}{4}<\/b>, {5}",s,o,nt?"":", "+u,p?"":tt+" ",a,d),String.format("<b>{0} {1}<\/b>{2} - <b>{3}{4}<\/b>, {5}",h,o,nt?"":", "+u,p?"":it+" ",a,d));nt?f.push(String.format("<b>{0} {1}<\/b> - {2}{3}",s,o,p?"":tt+" ",a),String.format("<b>{0} {1}<\/b> - {2}{3}",h,o,p?"":it+" ",a),String.format("<b>{0} {1}<\/b>, {2}",s,o,u),String.format("<b>{0} {1}<\/b>, {2}",h,o,u)):f.push(String.format("<b>{0} {1}<\/b>, {2} - <b>{3} {4}<\/b>",s,o,u,tt,a),String.format("<b>{0} {1}<\/b>, {2} - <b>{3} {4}<\/b>",h,o,u,it,a),String.format("<b>{0} {1}<\/b>, {2}",s,o,u),String.format("<b>{0} {1}<\/b>, {2}",h,o,u));break;case"agenda":case"day":var pt=t.DayNames[ct[vt]],wt=new RegExp(pt+"(.?) ","i"),rt=String.format("{0:"+t.MonthDayPattern+"}",e),bt=new RegExp(rt,"i"),ht=String.format("{0:"+t.LongDatePattern+"}",e).replace(bt,"<b>"+rt+"<\/b>"),lt=ht.replace(wt,"");f=[ht,lt,lt.replace(t.MonthGenitiveNames[e.getMonth()],t.AbbreviatedMonthGenitiveNames[e.getMonth()])];e.getFullYear()==(new Date).getFullYear()&&f.push("<b>"+rt+"<\/b>",String.format("<b> {0:"+t.MonthDayPattern.replace(/M+/,"MMM")+"}<\/b>",e));f.push(e.toLocaleDateString())}for(f[0]&&(ut=f[0].replace(/<\/?b>|&nbsp;/g,""),c.html(f[0]).attr("title",ut).attr("data-cal-value",ut));c[0].clientWidth+5>yt;){if(ft=f[st],!ft)break;c.html(ft);st++}ot?c.removeClass("app-has-droparrow"):c.addClass("app-has-droparrow");ei=null}},300))},scrollView:function(t){var f=this.scrollable(),o=this.dataView,r=this.getVisibleView(),i,e=t=="next"?1:-1,u;i=t!="today"?this.getViewHandler().getNextDate(r,e):new Date;u=this.getBlockByDate(r,i);u.length?this.scroll({date:i,animate:!0,view:r}):(this.navigateDate=i,n.presenter("show",{id:this.dataView._id,name:"calendar",container:f}))},loadData:function(n){var t=this,f=t.dataView.extension().viewStyle();if(this.mode=="agenda"&&t.activeCalendar.colorMap.load(!0),n.is(":visible")&&this.mode!="agenda"&&f=="calendar"){var i=n.closest(".app-wrapper"),r=t.getFirstVisibleBlock(i),u=t.getLastVisibleBlock(i);r&&u&&t.loadDataInBlock(n,r,u)}},loadDataInBlock:function(n,t,r){function h(){o?u.loadDataInBlock(n,o,r):u.activeCalendar.colorMap.load(!0)}var u=this,o=t.next(":not(.current-time-line)"),s=u.mode,f,e;if(t[0]!=r[0]&&o.length||(o=null),!this.loadingData&&u.mode!="agenda")if(t.hasClass("data-loaded"))h();else{if(!u.blockIsVisible(n,t)){h();return}f=i(t);e=this.cache.select(f);e?($.isEmptyObject(e)||this.getViewHandler().addData(n,f,e),this.loadingData=!1,t.addClass("data-loaded"),h()):this.requestData({mode:s,date:f,success:function(i){u.cache.insert(f,i.Pivots.pivot0.Data.slice(1));callback=function(){if(u.blockIsVisible(n,t)){switch(s){case"day":t.find("td > ul").empty();break;case"week":t.find("td > ul").empty();break;case"month":t.find("td > ul").empty();break;case"year":t.find("td.app-has-data").removeClass("app-has-data");break;case"agenda":return}t.addClass("data-loaded");e=u.cache.select(f);$.isEmptyObject(e)||u.views[s].addData(n,f,e);h()}pt=null};yt&&!s.match(/day|week/)?pt=callback:callback()}})}},requestData:function(n){var i=this,t=i.activeCalendar,u={controller:i.dataView._controller,command:n.mode=="agenda"?"Select":"Pivot",view:i.dataView._viewId,sort:t.date.Name,tags:i.dataView.get_tags(),fieldFilter:[t.date.Name],success:function(t){i.loadingData=!1;n.success(t)},error:function(n){i.loadingData=!1;$app.alert(String.format("{0}",n.get_message()))}};if(t.text&&(u.fieldFilter.push(t.text.Name),t.text.AliasIndex!=0&&u.fieldFilter.push(i.dataView._allFields[t.text.AliasIndex].Name)),t.color&&(u.fieldFilter.push(t.color.Name),t.color.AliasIndex!=0&&u.fieldFilter.push(i.dataView._allFields[t.color.AliasIndex].Name)),t.end&&u.fieldFilter.push(t.end.Name),n.mode){t=i.activeCalendar;var o=n.date,r=new Date(o),e={},f=e[t.date.Name]=["calendar-date","pivot-val2-count","pivot-row1-year","pivot-row2-month-raw","pivot-row3-day"],s=e[t.text.Name],h=t.color?e[t.color.Name]:null,c=t.end?e[t.end.Name]=["calendar-end"]:null;s||(s=e[t.text.Name]=["calendar-text"]);t.color&&!h&&(h=e[t.color.Name]=["calendar-color"]);switch(n.mode){case"daylist":r.setDate(r.getDate()+1);f.push("pivot-val1-calendar-first100");break;case"day":r.setDate(r.getDate()+1);f.push("pivot-row4-halfhour");f.push("pivot-val1-calendar");break;case"week":r.setDate(r.getDate()+7);f.push("pivot-row3-day","pivot-row4-halfhour");f.push("pivot-val1-calendar");break;case"month":r.setMonth(r.getMonth()+1);f.push("pivot-row3-day");f.push("pivot-val1-calendar-first5");break;case"year":r.setYear(r.getFullYear()+1);f.push("pivot-row3-day")}r.setSeconds(-1);u.pivotDefinitions=e;u._filter=lt(i.dataView,t.date,null,o,r)}else n.pivots&&n.date&&n.end&&(u.pivotDefinitions=n.pivots,u._filter=lt(i.dataView,t.date,null,n.date,n.end));i.loadingData=!0;$app.execute(u)},blockIsVisible:function(n,t){var i;if(!n.is(":visible"))return!1;if(i=n.closest(".app-wrapper"),this.mode.match(/month|year/)){var r=i.offset().top,f=r+i.height(),u=t.offset().top,e=u+t.height(),s=u<=f&&u>=r,h=e>=r&&e<=f,c=u<=r&&e>=f;return s||h||c}if(this.mode.match(/day|week/)){var l=i.width(),o=t.position().left,a=o+t.width();return a>=0&&o<=l}return!0},hasKeyFields:function(){return this.dataView._keyFields.length>0},getCurrentKey:function(){if(!this.hasKeyFields())return null;var t=this.dataView._keyFields[0],n=this.dataView.extension().commandRow();return n?n[t.Index]:null},getEventTitle:function(n,t,i,r){var u=f(n,!0);return t&&(u+="-"+f(t,!0)),u+="\n"+(i?i:o.Data.NullValueInForms),this.activeCalendar.color&&r!=""&&(u+="\n"+(r?r:o.Data.NullValueInForms)),u},getActionsByName:function(t){var i=[],r=[];return n.navContext(i),i.forEach(function(n){n.command==t&&r.push(n)}),r},drawDayData:function(n,t,i,r){var u=this;i.rows.forEach(function(t){var i=u.drawEvent(t,r);i.appendTo(n)});this.resizeDayData(n.find("li"))},drawEvent:function(t,i){var e=this,y=t[0],s=t[1],u=t[2],c=t[3],h=t[4],l=f(s,!1,!0),a=f(s);u&&(l+="-"+f(u,!1,!0),a+=" - "+f(u));var v=String.format('<div class="app-event-data"><span class="app-event-time">{0}<\/span> {1} <div class="app-event-time-long">{2}<\/div><\/div>',l,h?h:o.Data.NullValueInForms,a),r=$('<li class="app-event"><\/li>').data("data-context",t),p=e.getEventTitle(s,u,h,c),w=e.activeCalendar.colorMap.className(c);return n.desktop()&&!this.dataView.get_isTagged("calendar-drag-disabled")&&(r.attr("data-draggable","calendar-event"),e.activeCalendar.end&&(v+='<div class="app-event-handle ui-icon-dots" data-draggable="calendar-event-handle"><\/div>')),i&&i==y&&r.addClass("app-calendar-selected"),u&&r.addClass("app-event-has-end-time"),r.addClass(w),r.html(v),r.attr("title",p),r},resizeDayData:function(n){var e=[],t=[],h=l/25,s=n.first().closest(".app-calendar-day").width()-(this.mode=="day"?150:10),c=this.mode=="day"?10:4,i,u,f,r;n.each(function(){var i=$(this);if(i.is(".app-event-more")){i.remove();return}var r=i.data("data-context"),t=r[1],n=r[2];!n||n.getTime()<t.getTime()?(n=new Date(t),n.setMinutes(n.getMinutes()+tu)):n.getDate()!=t.getDate()&&(n=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59));e.push({element:i,data:r,start:t.getTime(),end:n.getTime(),depth:1,width:0})});e.sort(function(n,t){return n.start!=t.start?n.start>t.start?1:-1:n.end!=t.end?n.end<t.end?1:-1:0});u=[];r=0;e.forEach(function(n){function e(){n.depth=t.length+1;n.depth>r&&(r=n.depth);t.push(n);u.push(n)}for(i=t.pop();i;)if(i.end<=n.start)i=t.pop(),i||(u.forEach(function(n){n.width=r}),r=0,u=[]);else{t.push(i);break}t.length>=c?f?(n.collapsed=!0,f.collapsedEvents.push(n.data)):(f=n,f.collapsedEvents=[n.data],e()):(f=null,e())});u.forEach(function(n){n.width=r});e.forEach(function(n){var i,r;if(n.collapsed)n.element.hide();else{var t=n.element,u=n.data[1],e=n.data[2],c=h*(u.getHours()+u.getMinutes()/60)+22,l=pr(n.start,n.end),f=s/n.width,a=s*(n.depth-1)/n.width;n.depth!=n.width&&(f*=1.3);n.collapsedEvents&&n.collapsedEvents.length>1&&(t.hide(),i="+"+n.collapsedEvents.length+" "+o.Mobile.More,t=$('<li class="app-event app-event-more ui-icon-dots"><\/li>').appendTo(t.closest("ul")).html(i).attr("title",i).data("data-more-context",n.collapsedEvents));r={top:c,"z-index":n.depth+2,marginLeft:a+"px",width:f-3+"px"};e&&(r.height=l);t.css(r)}})}};bi=function(n){this.calendar=n};bi.prototype={draw:function(n,t){var u,a;n.find(".app-calendar-dayview").remove();var i=$('<div class="app-calendar-dayview"><\/div>').appendTo(n),o=i.closest(".app-echo").length>0,s=i.closest(".app-presenter"),v=i.closest(".app-wrapper"),h=s.data("cal-header"),l=o?null:s.data("cal-footer"),c=o?1:y.day*7,p=(y.day-1)/2*7,r=new Date(t.getFullYear(),t.getMonth(),t.getDate()),f='<div class="app-calendar-day-grid"><div class="current-time-line"><div class="dot"><\/div><\/div>';return r.setDate(r.getDate()-e[r.getDay()]),h.find(".app-day-header").remove(),u=$('<div class="app-day-header" data-draggable="calendar-bar-day"><\/div>').appendTo(h),a=$("<ul> "+this.calendar.drawDayHeaders(r,c)+" <\/ul>").appendTo(u),d(u),f+=this.calendar.drawDayColumns(r,c,!0),f+="<\/div>",i.html(f).find(".app-calendar-day").hide(),this.resize(i,u,l),this.scroll({view:i,date:t,enhancePrecision:!0}),i},showHeaderAndFooter:function(n,t){n.find(".app-day-header").show();n.find(".app-week-header").hide();n.find(".app-month-header").hide();$app.touch.bar("show",t);this.calendar.lastDayScrollTop=this.calendar.scrollable().scrollTop()},resize:function(n,t,i){t.is(".app-day-header")||(t=t.find(".app-day-header"));var u=n.closest(".app-echo").length>0,k=n.find(".app-calendar-day-grid"),f=n.find(".app-calendar-day"),r=t.find("li"),d=this.calendar.scrollable(),e=d.outerWidth(),g=Math.floor(e/7),c=f.length*e,a=this.calendar.navigateDate&&!this.calendar.preventNavigate,o,h,v,y,p,w;if(a||(o=rt(f),h=u?null:rt(r),v=o.position().left,y=u?0:h.position().left,p=parseInt(n.css("marginLeft"),10)*-1,w=u?0:parseInt(t.css("marginLeft"),10)*-1),k.width(c),t.width(r.width()*r.length),r.closest("ul").css("visibility",""),r.width(g),f.width(e).fadeIn("fast"),n.height(l),!u){if(a)this.scroll({view:n,date:this.calendar.navigateDate});else{var nt=o.position().left,tt=h.position().left,it=v-nt,b=Math.floor(y-tt);b!=0&&t.css("marginLeft",w*-1+b);this._scroll(n,t,p-it,i)}i!=null&&this.calendar.resizeScroller(n,i,c)}s();this.resizeData(n)},scroll:function(t){var e=this,r=e.calendar,o=r.dataView.extension().commandRow(),y=r.scrollable(),u=t.view,p=t.animate,h=u.closest(".app-presenter"),w=h.data("cal-header").find(".app-day-header"),b=h.data("cal-footer"),i=t.date,c=r.getBlockByDate(u,i),l,a,f,v;c.length&&(l=parseInt(u.css("marginLeft"),10),a=c.position().left,e._scroll(u,w,a-l,b,p));t.enhancePrecision&&(o?(v=o[r.activeCalendar.date.Index],f=s(v,"find")):f=i.getHours()==0&&i.getMinutes()==0&&i.getSeconds()==0&&i.getMilliseconds()==0?r.lastDayScrollTop||s():s(i,"find"),n.scroll(y,f))},_scroll:function(t,r,u,f,e){var h;n.animate()||(e=!1);var l=parseInt(t.css("marginLeft"),10),s=u*-1,o=this,c=t.find(".app-calendar-day-grid");if(t.removeClass("app-has-current-day"),si++,e==!0){t.animate({marginLeft:s},bt,function(){o._scroll(t,r,u,f)});return}t.css("marginLeft",s);h=this.updateDayHeader(t,r);clearTimeout(wt);wt=setTimeout(function(){var n=t.find(".app-calendar-day"),e=rt(n),k=n.width(),a=u%k,v,w=y.day*7,b=hi.day*7,nt,tt,et,p,it,ht,ct,d,g;if(si==1&&a!=0?(s>l?(a=a*-1,e=e.prev(),e.is(".current-time-line")&&(e=e.prev())):(a=k-a,e=e.next(),e.is(".current-time-line")&&(e=e.next())),h=o.updateDayHeader(t,r,e)):a=a>k/2?k-a:a*-1,tt=s-a,et=tt*-1,u<k)p=n.first(),nt=p.position().left,v=i(p),v.setDate(v.getDate()-w),$(o.calendar.drawDayColumns(v,w,!0)).prependTo(c),ht=$(o.calendar.drawDayHeaders(v,w)).prependTo(r.find("ul")),n=t.find(".app-calendar-day"),ct=r.find("li"),n.length>b&&(n.slice(b,n.length).remove(),r.find("li").slice(b,n.length).remove()),t.css("marginLeft",(p.position().left-nt)*-1),r.css("marginLeft",h.position().left*-1),f&&o.resize(t,r,f);else if(u>n.width()*(n.length-2)){p=n.last();nt=p.position().left;v=i(p);v.setDate(v.getDate()+1);$(o.calendar.drawDayColumns(v,w,!0)).appendTo(c);$(o.calendar.drawDayHeaders(v,w)).appendTo(r.find("ul"));var ct=r.find("li"),ut=n.length+w,ot=0;it=0;ut>b&&(d=n.slice(0,ut-b),g=r.find("li").slice(0,ut-b),ot=d.width()*d.length,it=g.width()*g.length,d.remove(),g.remove());t.css("marginLeft",parseInt(t.css("marginLeft"),10)+ot-a);r.css("marginLeft",parseInt(r.css("marginLeft"),10)+it);f&&o.resize(t,r,f)}else{function st(){f&&f.length&&f.scrollLeft()!=et&&o.calendar.resizeScroller(t,f);o.calendar.updateHeader(r.closest(".app-bar-calendar"))}a!=0?t.animate({marginLeft:tt},{duration:bt,done:st}):st()}e.is(".current-day-column")&&t.addClass("app-has-current-day");ft();si=0},250)},updateDayHeader:function(n,t,r){var a=n.find(".app-calendar-day"),v=r&&r.length?r:rt(a),u=i(v),s=rt(t.find("ul li")),f=i(s),o=s,h,c,l;return t.find("li .visible-day").removeClass("visible-day"),h=t.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"] > a > div',u.getFullYear(),u.getMonth(),u.getDate())),h.addClass("visible-day"),u.setDate(u.getDate()-e[u.getDay()]),f.setDate(f.getDate()-e[f.getDay()]),f.getTime()!=u.getTime()&&(o=t.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"]',u.getFullYear(),u.getMonth(),u.getDate())),o.length&&(c=parseInt(t.css("marginLeft"),10),l=c-o.position().left,t.css("marginLeft",l))),this.calendar.updateHeader(t.closest(".app-bar-calendar")),o},addData:function(n,t,i){var f=this.calendar.getBlockByDate(n,t,"day"),r=f.find("ul.app-calendar-eventlist"),e=this.calendar.dataView._keyFields[0],u=this.calendar.dataView.extension().commandRow(),o=u?u[e.Index]:null;r.empty();typeof i!="boolean"&&this.calendar.drawDayData(r,t,i,o)},resizeData:function(n){var t=this.calendar,i=n.find(".app-calendar-day");i.each(function(){var i=$(this),n=i.find("li.app-event:not(.app-event-preview)");n.length&&t.resizeDayData(n)})},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-dayview"),t;i.length&&(t=i.find("div.app-calendar-day.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-event").remove())},getNextDate:function(n,t){var u=this.calendar.getMostVisibleBlock(),r=i(u);return r.setDate(r.getDate()+t),r},getBlocks:function(){return this.calendar.scrollable().find(".app-calendar-dayview > .app-calendar-day-grid > .app-calendar-day")}};ki=function(n){this.calendar=n};ki.prototype={draw:function(n,t){var f,w,u,a;t.setDate(t.getDate()-e[t.getDay()]);n.find(".app-calendar-weekview").remove();var i=$('<div class="app-calendar-weekview"><\/div>').appendTo(n),o=this.calendar,v=i.closest(".app-echo").length>0,h=v?7:y.week,c=i.closest(".app-presenter"),b=i.closest(".app-wrapper"),l=c.data("cal-header"),p=c.data("cal-footer"),r=new Date(t.getTime());return r.setDate(r.getDate()-h),l.find(".app-week-header").remove(),f=$('<div class="app-week-header" data-draggable="calendar-bar-week"><\/div>').appendTo(l),w=$("<ul>"+o.drawDayHeaders(r,h*3)+"<\/ul>").appendTo(f),d(f),u='<div class="app-calendar-week-grid"><div class="current-time-line"><div class="dot"><\/div><\/div>',u+=o.drawTimeColumn(r),u+=o.drawDayColumns(r,h*3,!1),u+="<\/div>",i.html(u),a=i.find(".app-calendar-week-grid").hide(),this.resize(i,f,p),this.scroll({view:i,date:t,enhancePrecision:!0}),this.validateCurrentDay(i,a),s(),i},showHeaderAndFooter:function(n,t){n.find(".app-day-header").hide();n.find(".app-week-header").show();n.find(".app-month-header").hide();$app.touch.bar("show",t);this.calendar.lastDayScrollTop=this.calendar.scrollable().scrollTop()},_timelineDot:function(n,t){var o=this.calendar.scrollable(),u=n.find(".app-calendar-week-grid"),f,i=u.find(".current-time-line .dot"),e,r;t?(r=i.show().width(),f=u.find(".current-day-column"),f.length&&(e=f.offset().left-o.offset().left-r/2+parseInt(u.css("margin-left")),e+r<o.width()-r*3?setTimeout(function(){i.css("marginLeft",e).show()}):i.hide())):i.hide()},resize:function(n,t,i){t.is(".app-week-header")||(t=t.find(".app-week-header"));var u=n.closest(".app-echo").length>0,a=n.find(".app-calendar-week-grid"),v=n.find(".app-calendar-week-grid > div:not(.current-time-line):not(.app-calendar-time) > div"),r=t.find("li"),y=this.calendar.scrollable(),p=y[0].scrollWidth-ht,f=Math.floor(p/7),e=f*(r.length+1)+ht,o=rt(r),w=u?0:o.position().left,h=u?0:parseInt(t.css("marginLeft"),10)*-1;if(r.width(f),r.closest("ul").css("visibility",""),v.width(f),a.width(e).fadeIn("fast"),n.height(l),!u){var b=o.position().left,c=w-b,k=h-c;this._timelineDot(n,!0);this._scroll(n,t,h-c,i);i!=null&&this.calendar.resizeScroller(n,i,e);this.resizeData(n)}s()},scroll:function(t){var a,v,f,y;t.date.setDate(t.date.getDate()-e[t.date.getDay()]);var o=this,r=o.calendar,u=t.view,p=t.animate,i=t.date,h=r.dataView.extension().commandRow(),c=u.closest(".app-presenter"),w=r.scrollable(),b=c.data("cal-header").find(".app-week-header"),k=c.data("cal-footer"),l=r.getBlockByDate(u,i);l.length&&(a=parseInt(u.css("marginLeft"),10),v=l.position().left-ht,o._scroll(u,b,v-a,k,p));t.enhancePrecision&&(h?(y=h[r.activeCalendar.date.Index],f=s(y,"find")):f=i.getHours()==0&&i.getMinutes()==0&&i.getSeconds()==0&&i.getMilliseconds()==0?r.lastDayScrollTop||s():s(i,"find"),n.scroll(w,f))},_scroll:function(t,r,u,f,e){function ut(){h.updateHeader(it);b||(u<st?ct():w.position().left<ot?lt():o.validateCurrentDay(t,c));f&&f.length&&f.scrollLeft()!=u&&h.resizeScroller(t,f);ft(tt);o._timelineDot(t,!0)}function v(n,t,i){var r=i.getDate();n.attr("data-cal-year",i.getFullYear()).attr("data-cal-month",i.getMonth()).attr("data-cal-day",r).data("calendar-colors",t.data("calendar-colors")).find("ul").empty().append(t.find("ul li"));n[0].className=t[0].className}function et(n,t){var i=t.getDate();n.attr("data-cal-year",t.getFullYear()).attr("data-cal-month",t.getMonth()).attr("data-cal-day",i);n.data("calendar-colors",null);n.find("ul").empty().removeClass("data-loaded");n[0].className="app-calendar-day";g(t)&&n.addClass("current-day-column")}function ct(){b=!0;var p=s.first(),nt=c.find(".current-time-line"),f=i(p),y=!1;f.setDate(f.getDate()-k);var w=r.find("li"),e=s.slice(0,7),l=s.slice(7,14),d=s.slice(14,21),n=new Date(f);return w.each(function(){var r=$(this),t=r.find("a div"),i=n.getDate();t.text(i);r.attr("data-cal-year",n.getFullYear()).attr("data-cal-month",n.getMonth()).attr("data-cal-day",i);g(n)?t.addClass("app-current-day"):t.removeClass("app-current-day");n.setDate(i+1)}),n=i(l.first()),d.each(function(t){v($(this),l.eq(t),n);n.setDate(n.getDate()+1)}),n=i(e.first()),l.each(function(t){v($(this),e.eq(t),n);n.setDate(n.getDate()+1)}),n=f,e.each(function(){et($(this),n);var i=h.cache.select(n);i&&(o.addData(t,n,i),y=!0);n.setDate(n.getDate()+1)}),o.validateCurrentDay(t,c),y&&o.resizeData(t),u-=a,u>0&&(u=0),t.css("marginLeft",u),r.css("marginLeft",u),a}function lt(){b=!0;var p=s.first(),nt=c.find(".current-time-line"),e=i(p),y=!1;e.setDate(e.getDate()+k);var w=r.find("li"),d=s.slice(0,7),l=s.slice(7,14),f=s.slice(14,21),n=new Date(e);return w.each(function(){var r=$(this),t=r.find("a div"),i=n.getDate();t.text(i);r.attr("data-cal-year",n.getFullYear()).attr("data-cal-month",n.getMonth()).attr("data-cal-day",i);g(n)?t.addClass("app-current-day"):t.removeClass("app-current-day");n.setDate(i+1)}),n=i(l.first()),d.each(function(t){v($(this),l.eq(t),n);n.setDate(n.getDate()+1)}),n=i(f.first()),l.each(function(t){v($(this),f.eq(t),n);n.setDate(n.getDate()+1)}),n=i(f.last()),n.setDate(n.getDate()+1),f.each(function(){et($(this),n);var i=h.cache.select(n);i&&(o.addData(t,n,i),y=!0);n.setDate(n.getDate()+1)}),o.validateCurrentDay(t,c),u-=a,y&&o.resizeData(t),u>0&&(u*=-1),t.css("marginLeft",u),r.css("marginLeft",u),a}var p,d,nt;n.animate()||(e=!1);var o=this,h=o.calendar,tt=h.scrollable(),ot=tt.width(),c=t.find(".app-calendar-week-grid"),s=c.find(".app-calendar-day"),it=r.closest(".app-bar-calendar"),w=s.last(),l=w.width(),at=w.position().left-ht+l,b=!1,rt=r.find("li:first-of-type"),vt=i(rt),st=rt.width()+2,yt=hi.week,k=y.week,a=l*k;o._timelineDot(t,!1);h.updateHeader(it);e==!0?(p=u%l,d=u*-1+(p>l/2?p-l:p),r.animate({marginLeft:d},bt),t.animate({marginLeft:d},bt,function(){setTimeout(function(){ut()})})):(nt=u*-1,r.css("marginLeft",nt),t.css("marginLeft",nt),clearTimeout(wt),wt=setTimeout(ut,250))},addData:function(n,t,i){var f=this.calendar.dataView._keyFields[0],u=this.calendar.dataView.extension().commandRow(),e=u?u[f.Index]:null,o=this.calendar.getBlockByDate(n,t,"day"),r=o.find("ul.app-calendar-eventlist");r.empty();r.data("calendar-event-count",i.count||0);this.calendar.drawDayData(r,t,i,e)},resizeData:function(n){var t=this.calendar,i=n.find(".app-calendar-day");i.each(function(){var i=$(this),n=i.find("li.app-event:not(.app-event-preview)");n.length&&t.resizeDayData(n)})},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-weekview"),t;i.length&&(t=i.find("div.app-calendar-day.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-event").remove())},validateCurrentDay:function(n,t){n.is(".app-has-current-day")?t.find(".current-day-column").length||n.removeClass("app-has-current-day"):t.find(".current-day-column").length&&n.addClass("app-has-current-day")},getNextDate:function(n,t){var f=this.calendar.getMostVisibleBlock(),r=i(f),u=e[r.getDay()];return u==0?r.setDate(r.getDate()+t*7):r.setDate(r.getDate()+(t==-1?u*-1:7-u)),r},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-weekview > .app-calendar-week-grid > .app-calendar-day")}};di=function(n){this.calendar=n};di.prototype={draw:function(n,i){var e,w,v,rt,it,p,ut;n.find(".app-calendar-monthview").remove();var r=$('<div class="app-calendar-monthview"><\/div>').hide().appendTo(n),ft=this.calendar,s=r.closest(".app-echo").length>0,nt=r.closest(".app-presenter"),h=nt.data("cal-header"),l=s?0:y.month,tt=i.getMonth(),f=new Date(i.getFullYear(),tt),a,it,u;for(f.setMonth(f.getMonth()-l),a=f.getMonth(),h.find(".app-month-header").remove(),e=$('<div class="app-month-header"><\/div>'),w=$("<ul><\/ul>").appendTo(e),u=0;u<7;u++){var o=ct[u],b=t.DayNames[o],k=t.AbbreviatedDayNames[o],g=$('<li><span class="letter-day">'+k.substring(0,1)+'<\/span><span class="abbr-day">'+k+'<\/span><span class="full-day">'+b+"<\/span><\/li").attr("title",b);(o==0||o==6)&&g.addClass("app-calendar-weekend");g.appendTo(w)}for(d(e),e.appendTo(h),$app.touch.bar("show",h),r.fadeIn("fast"),v=$('<div class="app-calendar-load-at-top"><\/div>').appendTo(r),rt=$('<a href="#" class="dv-load-at-top ui-btn"/>').appendTo(v).text(c.Loading),s&&v.hide(),u=l*-1;u<=l;u++)it=this.drawMonth(f).appendTo(r),f.setMonth(a+1),a=f.getMonth();return this.resize(r),p=$('<div class="app-calendar-load-at-bottom"><\/div>').appendTo(r),ut=$('<a href="#" class="dv-load-at-bottom ui-btn">Load more<\/a>').appendTo(p).text(c.Loading),s&&p.hide(),this.scroll({date:i,view:r}),r},showHeaderAndFooter:function(n,t){n.find(".app-day-header").hide();n.find(".app-week-header").hide();n.find(".app-month-header").show();$app.touch.bar("hide",t)},resize:function(n,t,i,r){var o=n.closest(".app-wrapper"),u=n.find(".app-calendar-month"),f=u.find("table"),e=o.height()-u.first().find(".app-calendar-month-header").outerHeight();r&&u.removeClass("data-loaded");f.height(e);f.each(function(){var t=$(this),n=t.find("tr");n.height(e/n.length)});this.calendar.navigateDate&&!this.calendar.preventNavigate&&this.scroll({view:n,date:this.calendar.navigateDate})},scroll:function(t){var s=this,l=t.date,r=s.calendar,u=r.getBlockByDate(t.view,t.date);if(u){var i=r.scrollable(),h=t.view.closest("div.app-presenter"),a=h.data("cal-header"),f=u.find(".app-calendar-month-header"),c=i.find(".app-presenter-instruction"),e=f.offset().top-i.offset().top+f.outerHeight(!0)-c.outerHeight(!0)+i.scrollTop(),o=function(){n.fetchOnDemand();ft(i)};t.animate?n.animatedScroll(i,e,o):(n.scroll(i,e),o())}},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-monthview"),t;i.length&&(t=i.find("div.app-calendar-month.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-event").remove())},drawMonth:function(n){var s=n.getMonth(),c=t.MonthNames[s],h=$('<div class="app-calendar-month"><\/div>').attr("data-cal-year",n.getFullYear()).attr("data-cal-month",s),l=$('<h1 class="app-calendar-month-header">').appendTo(h),y=$("<table><\/table>").appendTo(h),o,r;s==0?l.text(String.format("{0} {1}",c,n.getFullYear())):l.text(c);var i=new Date(n.getFullYear(),n.getMonth(),1),u=e[i.getDay()],f=new Date(n.getFullYear(),n.getMonth()+1,1),a=e[f.getDay()],v;for(a!=0&&f.setDate(f.getDate()+(6-a)+1),u!=0&&i.setDate(i.getDate()-u);i<f;){if(o=i.getDay(),u=e[o],u==0&&(v=$("<tr><\/tr>").appendTo(y)),r=$("<td><\/td>").appendTo(v),(o==0||o==6)&&r.addClass("app-calendar-weekend"),i.getMonth()==n.getMonth()){r.html("&nbsp;");r.attr("data-cal-day",i.getDate());var p=$('<a class="ui-btn"><\/a>').appendTo(r),w=$("<span><\/span>").text(i.getDate()).appendTo(p),b=$("<ul><\/ul>").appendTo(r),k=$('<li class="app-calendar-month-more"><\/li>').appendTo(b);st.setHours(0,0,0,0)==i.setHours(0,0,0,0)&&w.addClass("app-current-day")}else r.html("&nbsp;");i.setDate(i.getDate()+1)}return h},addData:function(n,t,i){var s=this.calendar,l=s.getBlockByDate(n,t,"month"),tt=s.dataView,ot=tt._keyFields[0],st=s.activeCalendar,r=s.dataView.extension().commandRow(),w=r?r[ot.Index]:null,a=r?r[st.date.Index]:null,it,v,ht=l.find("td").first(),ct=l.find("td > a").first(),rt=l.find("ul"),b,et;rt.hide();it=ht.outerHeight()-ct.height();rt.show();for(b in i){var k=i[b],d=k.count,h=null,y=l.find('td[data-cal-day="'+b+'"] ul'),e=0,p,c=$('<li class="app-calendar-month-more"><\/li>');for(v=!1,y.empty().data("calendar-event-count",d);e<5;){if(r=k.rows[e],!r)break;t=r[1];var lt=r[0],g=r[2],ut=r[3],nt=r[4],ft=f(t,!1,!0);g&&(ft+="-"+f(g,!1,!0));var at=String.format('<span class="app-event-time">{0}<\/span> {1}',ft,nt?nt:o.Data.NullValueInForms),u=$('<li class="app-event"><\/li>').data("data-context",r),vt=s.getEventTitle(t,g,nt,ut),yt=s.activeCalendar.colorMap.className(ut);if(tt.get_isTagged("calendar-drag-disabled")||u.attr("data-draggable","calendar-event"),h||(h=t),w&&w==lt&&(u.addClass("app-calendar-selected"),p=u),u.addClass(yt),u.html(at),u.attr("title",vt),u.appendTo(y),e++,y.height()>it&&d!=1){u.remove();v=!0;e--;break}}(v||e<k.count)&&(c.appendTo(y),v&&(et=c.prev(),et.length&&(c.prev().remove(),e--)),c.html(String.format(ru,d-e)),w&&a&&a.getDate()==h.getDate()&&a.getMonth()==h.getMonth()&&a.getFullYear()==h.getFullYear()&&(p&&(!p||p.is(":visible"))||c.addClass("app-calendar-selected")))}},getNextDate:function(n,t){var u=this.calendar,e=u.getMostVisibleBlock(),r=i(e),n,f;return r.setMonth(r.getMonth()+t),n=u.getVisibleView(),f=u.getBlockByDate(n,r),f.length||(t==1?n.find(".dv-load-at-bottom").trigger("vclick"):n.find(".dv-load-at-top").trigger("vclick")),r},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-monthview > .app-calendar-month")}};gi=function(n){this.calendar=n};gi.prototype={draw:function(n,t){var r,h,f,l;n.find(".app-calendar-yearview").remove();var i=$('<div class="app-calendar-yearview"><\/div>').hide().appendTo(n),u=i.closest(".app-echo").length>0,e=u?0:y.year,o=t.getFullYear(),s=$('<div class="app-calendar-load-at-top"><\/div>').appendTo(i),a=$('<a href="#" class="dv-load-at-top ui-btn"/>').appendTo(s).text(c.Loading);for(u&&s.hide(),r=o-e;r<=o+e;r++)h=this.drawYear(new Date(r,0)).appendTo(i);return i.fadeIn("fast"),f=$('<div class="app-calendar-load-at-bottom"><\/div>').appendTo(i),l=$('<a href="#" class="dv-load-at-bottom ui-btn">Load more<\/a>').appendTo(f).text(c.Loading),u&&f.hide(),this.scroll({view:i,date:t}),i},showHeaderAndFooter:function(n,t){n.find(".app-day-header").hide();n.find(".app-week-header").hide();n.find(".app-month-header").hide();$app.touch.bar("hide",t)},drawYear:function(n){for(var h,r,u,o,s,f=n.getFullYear(),e='<div class="app-calendar-year" data-cal-year="'+f+'"><h1>'+f+"<\/h1>",i=0;i<=11;i++){for(h=t.AbbreviatedMonthNames[i].toUpperCase(),r='<div class="app-calendar-month" data-cal-month="'+i+'"><a class="ui-btn app-calendar-month-header">'+h+"<\/a><table><thead>",u=0;u<7;u++)r+="<th>"+t.ShortestDayNames[ct[u]].substr(0,1)+"<\/th>";r+="<\/thead><tbody>";r+=yr(f,i);e+=r+"<\/tbody><\/table><\/div>"}return e+='<div class="app-clear-fix"><\/div><\/div>',o=$(e),s=this.calendar.cache.select(n),s&&this.addData(null,n,s,o.addClass("data-loaded")),o},addData:function(n,t,i,r){var f=this.calendar,e=r||f.getBlockByDate(n,t,"year"),u,o,s;e.find("td.app-has-data").removeClass("app-has-data").attr("title",null);for(u in i)o=i[u],s=e.find('div[data-cal-month="'+u+'"]'),s.find("td").each(function(){var t=$(this),i=t.text(),n;i.trim().length&&(n=o[i],n&&n.count&&t.addClass("app-has-data").attr("title",String.format("{0} ({1})",f.activeCalendar.date.Label,n.count)))})},scroll:function(t){function o(){n.fetchOnDemand();u.updateHeader(l);ft(i)}var s=this,h=t.date,u=s.calendar,i=u.scrollable(),c=t.view.closest("div.app-presenter"),l=c.data("cal-header"),r=u.getBlockByDate(t.view,t.date),e,f;r&&(r=r.find('div.app-calendar-month[data-cal-month="'+h.getMonth()+'"]'),e=i.find(".app-presenter-instruction"),f=r.offset().top+i.scrollTop()-i.offset().top-e.outerHeight(),t.animate?n.animatedScroll(i,f,o):(n.scroll(i,f),o()))},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-yearview"),t;i.length&&(t=i.find("div.app-calendar-year.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-has-data").removeClass("app-has-data").attr("title",null))},resize:function(n){this.calendar.navigateDate&&this.scroll({view:n,date:this.calendar.navigateDate})},getNextDate:function(n,t){var u=this.calendar,e=u.getMostVisibleBlock(),r=i(e),n,f;return r.setYear(r.getFullYear()+t),n=u.getVisibleView(),f=u.getBlockByDate(n,r),f.length||(t==1?n.find(".dv-load-at-bottom").trigger("vclick"):n.find(".dv-load-at-top").trigger("vclick")),r},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-yearview > .app-calendar-year")}};nr=function(n){this.calendar=n};nr.prototype={draw:function(n,t){var i=n.find(".app-calendar-agendaview");i.length||(i=$('<div class="app-calendar-agendaview"><\/div>').appendTo(n));var r=this,f=this.calendar,p=f.activeCalendar,w=f.dataView,l=i.closest(".app-echo").length>0,e=new Date(t),u=i.find(".app-calendar-agenda-list"),v=u.length&&i.is(".data-loaded"),y=i.closest(".app-wrapper"),a=y.find(".app-presenter-instruction"),o=i.find(".app-calendar-load-at-top"),s=i.find(".app-calendar-load-at-bottom"),h=i.find(".app-echo-footer");return l?i.height(f.echoMaxHeight):a.css("visibility","hidden"),v||(u.length||(u=$('<ul class="app-calendar-agenda-list"><\/ul>').hide().appendTo(i)),l?h.length||(h=$('<div class="app-echo-footer"><div class="app-echo-container-see-all"><a class="ui-btn-icon-left ui-btn ui-icon-carat-r dv-action-see-all"/><\/div><\/div>').hide().appendTo(i)):(o.length||(o=$('<div class="app-calendar-load-at-top"><\/div>').hide().prependTo(i),$('<a href="#" class="dv-load-at-top ui-btn"/>').text(c.Loading).appendTo(o)),s.length||(s=$('<div class="app-calendar-load-at-bottom"><\/div>').hide().appendTo(i),$('<a href="#" class="dv-load-at-bottom ui-btn"><\/a>').text(c.Loading).appendTo(s)))),f.cache.clearAgenda(),r.minPage=0,r.maxPage=0,r.todayLoaded=!1,r.lastDate=e,r.loadData(i,e,0,function(n,f){r.loadData(i,e,-1,function(c,v){var y;u.empty();var it={"0":n["0"],"-1":c["-1"]},w=r.drawData(i,e,it),b=r.calendar.cache.select(1),k=r.calendar.cache.select(-2);if(u.show(),i.fadeIn("fast").css("height",""),l){var d=w[0],rt=w[1],g=f+v,nt=d+rt,p=v-d+1,tt=p+nt-1;nt!=g&&(y=h.find(".dv-action-see-all"),y.empty(),h.show(),$('<span class="app-btn-see-all"/>').appendTo(y).text(ot.SeeAll).attr("title",ot.SeeAll),$('<span class="app-info"/>').appendTo(y).attr({"data-start-index":p,"data-end-index":tt}).html(String.format(ii.ShowingItems,p,tt,g)))}else a.css("visibility",""),b&&b.length==0||s.show(),k&&k.length==0||o.show(),r.scroll({view:i,date:t})})}),i},showHeaderAndFooter:function(n,t){n.find(".app-day-header").hide();n.find(".app-week-header").hide();n.find(".app-month-header").hide();$app.touch.bar("hide",t)},getNextDate:function(n,t){var u=this.calendar.scrollable(),s=u.scrollTop(),f=this.calendar.getFirstVisibleBlock(u),h=n.find(".app-calendar-agenda-list li:not(.app-calendar-month-header)").first(),e,o,r;return i(f).getTime()==i(h).getTime()?(e=n.find(".dv-load-at-top"),e.is(":visible")&&e.trigger("vclick")):t==1&&s+u.height()>u[0].scrollHeight-20&&(o=n.find(".dv-load-at-bottom"),o.is(":visible")&&o.trigger("vclick")),r=t==1?f.next():f.prev(),r.is(".app-calendar-month-header")&&(r=t==1?r.next():r.prev()),r.length?i(r):i(f)},scroll:function(t){var s=this.calendar,f=t.view||s.getVisibleView(),e=t.date,o,h;if(!f.hasClass("data-loaded")){this.draw(f.closest(".app-calendar"),e);return}var u=s.scrollable(),l=f.closest(".app-presenter"),y=l.data("cal-header"),r=s.getBlockByDate(f,e),c=this.getBlocks().first(),a=i(c),v=u.find(".app-presenter-instruction");if(r.length)r=r.closest(".app-agenda-day-list");else for(r=c;r.length&&i(r)<=e;)r=r.next(),r.is(".app-calendar-month-header")&&(r=r.next());r.length&&(o=0,h=function(){n.fetchOnDemand();ft(u)},ai(e,a)||(o=u.scrollTop()+r.offset().top-u.offset().top-v.height()),t.animate?n.animatedScroll(u,o,h):(n.scroll(u,o),h()))},resize:function(n){this.calendar.navigateDate&&this.scroll({view:n,date:this.calendar.navigateDate})},clear:function(n){n||(n=this.calendar.getViews().filter(".app-calendar-agendaview"));n.removeClass("data-loaded");n.find(".app-calendar-load-at-top, .app-calendar-load-at-bottom").hide();this.todayLoaded=!1;this.calendar.cache.clearAgenda()},loadData:function(n,t,i,r){var c;t||(t=this.lastDate);var f=this,u=f.calendar,s=u.activeCalendar,e=u.dataView,y=n.closest(".app-echo").length>0,p=n.find(".app-calendar-agenda-list"),h=i<0,a=h?lt(e,s.date,s.end,null,t):lt(e,s.date,s.end,t,null),v=s.date.Name+(h?" desc":" asc"),o={},l=i>=0?i:Math.abs(i)-1;i>f.maxPage?f.maxPage=i:i<f.minPage&&(f.minPage=i);c=u.cache.select(i);c?(o[i]=c,r?r(o):f.drawData(n,t,o)):(u.loadingData=!0,$app.execute({controller:e._controller,view:e._viewId,command:"Select",_filter:a,sort:v,pageSize:kt*2,pageIndex:l/2,requiresRowCount:!0,tags:e.get_tags(),success:function(s){var v,y,c,a;(u.loadingData=!1,v=s[e._controller],y=s.totalRowCount<=(l+1)*kt*2,u.mode=="agenda")&&(c=v.splice(0,kt),a=v,h?(c.reverse(),a.reverse(),u.cache.insert(i,c),u.cache.insert(i-1,a),y&&u.cache.insert(i-2,[])):(u.cache.insert(i,c),u.cache.insert(i+1,a),y&&u.cache.insert(i+2,[])),o[i]=c,r?r(o,s.totalRowCount):f.drawData(n,t,o,s.totalRowCount))},error:function(n){u.loadingData=!1;$app.alert(String.format("{0}",n.get_message()))}}))},drawData:function(i,r,u){function bt(n,t){var w=b&&n[b.Name],r=n[ui],u=n[yt],s=pt&&n[pt],y=ht&&n[ht],k=e.colorMap.className(y),p=a.getDayList(h,r,t?"prepend":"append"),i=$("<li><\/li>").attr("data-cal-page",ot),d=$('<span class="app-event-time"><\/span>').appendTo(i),l=f(r),v=$('<div class="app-event"><\/div>').text(u?u:o.Data.NullValueInForms).data("data-context",n).appendTo(i);return v.attr("title",c.getEventTitle(r,s,u,y)).addClass(k),it&&it==w&&v.addClass("app-calendar-selected"),s&&(l+=" - "+f(s)),d.text(l),$('<div class="app-event-time"><\/div>').text(l).appendTo(v),t?i.prependTo(p):i.appendTo(p),i}var a=this,c=a.calendar,h=i.find(".app-calendar-agenda-list"),ii=c.scrollable(),ri=i.closest(".app-echo").length>0,e=c.activeCalendar,vt=c.dataView,ui=e.date.Name,yt=e.text.Name,ht=e.color&&e.color.Name,pt=e.end&&e.end.Name,b=c.dataView._keyFields[0],wt=c.dataView.extension().commandRow(),it=wt?wt[b.Index]:null,rt=c.getMostVisibleBlock(),fi=rt?rt.position().top:0,v,ct,et,nt,lt,at,ot,tt,st,l,y,gt;if(e.text.AliasName&&e.text.AliasName.length&&(v=vt.findField(e.text.AliasName),v&&(yt=v.Name)),e.color&&e.color.AliasName&&e.color.AliasName.length&&(v=vt.findField(e.color.AliasName),v&&(ht=v.Name)),ri){for(var y=a.calendar.cache.select(0),l=a.calendar.cache.select(-1),ei=l.length&&l[0][b.Name],p=0,d=0,w=!0,ut=!0,dt=c.echoMaxHeight-i.find(".app-echo-footer").height(),oi=y.length+l.length,g=0,s,ft;(h.outerHeight(!0)<dt||g<3)&&g<oi;){if(y.length<=p&&(w=!1),l.length<=d){if(y.length<=p)break;w=!0;ut=!1}ct=w&&!ut?y[p++]:l[d++];ct?(g++,bt(ct,!w)):(w?p--:d--,w=!1);ut&&(ut=!1)}for(a.validateToday(h,h.children(),r),s=h.find(".app-agenda-day-list:first"),ft=s.attr("data-cal-year"),s.length&&ft!=(new Date).getFullYear().toString()&&$("<h1/>").appendTo($('<li class="app-calendar-month-header" data-cal-year="'+ft+'" data-cal-month="'+s.attr("data-cal-month")+'"/>').insertBefore(s)).text(ft),s=h.find("li.app-agenda-day-list").first(),et=!1,nt=s.find("li").first();h.outerHeight(!0)>dt&&g>3;)lt=nt.find(".app-event").data("data-context"),at=lt&&lt[b.Name],it&&(at==it||at==ei)?et=!0:(nt.remove(),g--,s.find("li").length==0&&(s.remove(),et?p--:d--)),et?(s=h.find("li.app-agenda-day-list").last(),nt=s.find("li").last()):(s=h.find("li.app-agenda-day-list").first(),nt=s.find("li").first());return[d,p]}for(ot in u)if(tt=u[ot],st=ot<0,tt.length<kt&&(l=i.find(".app-calendar-load-at-top"),y=i.find(".app-calendar-load-at-bottom"),st?l.hide():y.hide()),tt.length>0)for(gt in tt)bt(tt[gt],st);var ni=c.getBlocks(),ti=[],si=k.getFullYear();ni.each(function(){var f=$(this),r=f.attr("data-cal-year"),u=f.attr("data-cal-month"),e=r+"-"+u,n;if(ti[e])return!0;for(monthHeader=i.find(String.format('li.app-calendar-month-header[data-cal-year="{0}"][data-cal-month="{1}"]',r,u)),monthHeader.length||(monthHeader=$(String.format('<li class="app-calendar-month-header ui-btn" data-cal-year="{0}" data-cal-month="{1}"><h1>{2}<\/h1><\/li>',r,u,t.MonthNames[u])).insertBefore(f),r!=si&&monthHeader.find("h1").text(t.MonthNames[u]+" "+r)),n=f.prev();n.length;){if(n.attr("data-cal-year")!=r||n.attr("data-cal-month")!=u){monthHeader.insertBefore(n.next());break}n=n.prev()}ti[e]=!0});a.validateToday(h,ni,r);i.addClass("data-loaded");rt&&st&&n.scroll(ii,rt.position().top-fi)},validateToday:function(n,t,r){var e,v,h;if(!this.todayLoaded){var c=t.first(),y=c.length?i(c):r,l=t.last(),p=l.length?i(l):r,w=y<st&&st<p,u,s;if(w||g(r)){if(this.todayLoaded=!0,e=this.getDayList(n,st,"search"),e.find(".app-time-line-container").length)return;var b=e.parents("li[data-cal-year]"),a=new Date,o=$('<li class="app-time-line-container"><\/li>').appendTo(e),k=$('<span class="app-event-time"><\/span>').text(f(a)).appendTo(o);for(timeLine=$('<div class="current-time-line"><div class="dot">&nbsp;<\/div><\/div>').appendTo(o),b.addClass("app-has-current-day"),u=o.prev();u.length;){if(v=u.find(".app-event"),h=v.data("data-context"),h&&h[this.calendar.activeCalendar.date.Name]>a)s=u;else break;u=u.prev()}s&&o.insertBefore(s)}}},removeData:function(n,t){n.find('.app-calendar-agenda-list li[data-cal-page="'+t+'"]').remove();t==this.maxPage?(n.find(".app-calendar-load-at-bottom .ui-btn").addClass("dv-load-at-bottom").text(c.Loading).show(),this.maxPage--):t==this.minPage&&(n.find(".app-calendar-load-at-top .ui-btn").addClass("dv-load-at-top").text(c.Loading).show(),this.minPage++);this.removeEmptyRows(n)},getDayList:function(n,r,u){var s=this.calendar.getBlockByDate(n,r),e,y,l,h;if(!s.length){var f=$('<li class="app-agenda-day-list"><\/li>').attr("data-cal-year",r.getFullYear()).attr("data-cal-month",r.getMonth()).attr("data-cal-day",r.getDate()),a=t.AbbreviatedDayNames[r.getDay()],p=$(String.format('<h2 class="ui-btn"><span class="app-calendar-daynumbig">{2}<\/span><span class="app-calendar-dayname">{0}<\/span> <span class="app-calendar-monthname">{1}<\/span> <span class="app-calendar-daynum">{2}<\/span><\/h2>',a,t.AbbreviatedMonthNames[r.getMonth()],r.getDate())).appendTo(f).attr("title",String.format("{0:"+t.LongDatePattern+"}",r)),v=$('<div class="app-calendar-day"><\/div>').appendTo(f),o=new Date,c=new Date;if(o.setDate(o.getDate()-1),c.setDate(o.getDate()+1),g(r)?f.addClass("app-calendar-agenda-today"):ai(r,o)?f.addClass("app-calendar-agenda-yesterday"):ai(r,c)&&f.addClass("app-calendar-agenda-tomorrow"),u=="prepend")f.prependTo(n);else if(u=="append")f.appendTo(n);else{for(e=n.find("li[data-cal-year]:first"),h=!1;e.length;){if(l=i(e),r<l){f.insertBefore(e);h=!0;break}y=e;e=e.next()}h||f.appendTo(n)}s=$("<ul><\/ul>").appendTo(v);d(f)}return s},removeEmptyRows:function(n){n.find(".app-calendar-agenda-list > li").each(function(){var t=$(this),e=t.is(".app-calendar-month-header"),r=i(t),u,f;e?(u=n.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day]',r.getFullYear(),r.getMonth())),u.length==0&&t.remove()):(f=t.find("ul .app-event"),f.length==0&&t.remove())})},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-agendaview > .app-calendar-agenda-list > li:not(.app-calendar-month-header)")}};$app.touch.presenter("register",{name:"calendar",icon:function(){return"calendar"},text:function(){return u.Text},supports:wr,show:function(n){var t=$app.find(n.id);t&&t.calendar&&t.calendar.show(n)},hide:function(t){var i=n.dataView();i&&i.calendar&&i.calendar.hide(t)},dispose:function(t){var i=n.dataView();i&&i.calendar&&(i.calendar.dispose(t),delete i.calendar)}});h=n.CalendarInput=function(t,i){function d(n){var t=$(n.target);t.closest('.app-input-text, .app-calendar-plugin-container, [data-field="'+p+'"]').length||(et.off("mousedown",d),h("hide",{container:u}))}function ot(n,t){var i={NewValue:t};return n._validateFieldValueFormat(e,i,!0),i.NewValue}function v(n,t,i,r){var u=tt(r),f=u?t.format(r):"";u||t.AllowNulls||(r=new Date,f=t.format(r));a||!i||i.parent().length==0?$app.input.execute({dataView:n,values:[{name:t.Name,value:r}]}):$app.input.value(f)}function nt(){u.hide().removeData("select-date");$(".app-calendar-cover").hide();et.off("mousedown",d);f&&f.select()}var u=i.container,f=i.input,c=i.dataView=i.dataView||f&&$app.find(f.closest("[data-input-container]").attr("data-input-container"))||n.dataView(),ft=c._id,o=u&&u.data("data-input"),e=i.field=i.field||o&&$app.input.elementToField(o),p=e&&e.Name,a=$app.touch.pointer()=="touch",s,k,g,rt,y,l,ut;if(f&&f.length){if(!f.parent().length&&!a){alert("TODO: input is detached!");return}if(s=f.closest(".app-wrapper"),u||(u=s.find(".app-calendar-plugin-container")),u.length||(u=$('<div class="app-calendar-plugin-container app-data-input-helper"><\/div>').hide().appendTo(s)),$('<div class="app-calendar-cover" style="display:none"><\/div>').appendTo(s),i.container=u,o=f.closest("[data-input]"),i.field=e=$app.input.elementToField(o),p=e.Name,u.data("data-input",o),e.tagged("calendar-input-disabled"))return!0;if(k=e.DataFormatString=="{0:t}"||e.DataFormatString=="{0:T}",i.showTime=!!(e.TimeFmtStr||k),i.hideDate=k,e.tagged("calendar-input-future")&&(i.limitStart=new Date,i.limitStart.setHours(0,0,0,0)),tt(i.date)||(t=="clear"?(v(i.dataView,e,f,""),i.date=new Date,t="setDate"):(i.date=c.convertStringToFieldValue(e,f.val()),tt(i.date)||(i.date=new Date))),i.onselect=function(n){var i=n.target.closest(".app-month-container"),t;i.length&&(w(i,n.date),i.find(".app-selected").removeClass("app-selected"),b(u,n.date).addClass("app-selected"),it());u.data("select-date",n.date);u.find(".app-calendar-action-bar:visible").length||(t=n.dataView.findField(p),t&&(v(n.dataView,t,f,n.date),n.endField&&(!t.TimeFmtStr||n.oldTimeMode=="Minute"&&n.target.closest(".app-time-selector").length)&&setTimeout(function(){f.blur();$app.input.execute({dataView:c,values:[{name:n.endField,value:n.date}]});setTimeout(function(){s.find(String.format('[data-field="{0}"]',n.endField)).first().trigger("vclick")},10)},250)),n.mode||u.find(".app-time-container:visible").length||nt())},i.onrefresh=function(n){n.monthContainer.find(".app-selected").removeClass("app-selected");var t=n.container.data("select-date")||n.date;tt(t)&&b(n.monthContainer,t).addClass("app-selected")},i.attachCallbacks=!0,!f.attr("data-datepicker-attached")){f.attr("data-datepicker-attached","true").focus(function(){var n,t,o=u.height(),h=u.width(),c=s.width(),l=s.height(),r=s.scrollTop(),e=a,v=$(".app-calendar-cover");if(br.width()<640)n=r+(l-o)/2,t=(c-h)/2,e=!0;else{var y=f.offset(),p=s.offset(),w=f.outerHeight();n=y.top-p.top+r+f.outerHeight();t=y.left-p.left;(kr||n+o>l+r)&&(n-=o+w,n<r&&(n=r+10,e=!0));t+h>c&&(t=c-h-10)}u.css({top:n,left:t});u.data("select-date",i.date);e?(u.addClass("app-calendar-touch"),v.show()):(u.removeClass("app-calendar-touch"),v.hide());a?u.stop(!0).fadeIn("fast"):u.show();(e||a)&&f.blur()}).on("input",function(){var n=$app.find(ft),t=ot(n,f.val());tt(t)&&h("setDate",{input:f,date:t,dataView:n,container:u})}).on("remove.input.app",function(){u.is(".app-calendar-touch")||(h("hide",{container:u}),u.removeData("select-date"))});et.on("mousedown",d)}}if(i.renderTime=!0,i.excludeKeyFieldsFromFilter=!0,i.queryData=function(n,t){return n&&n.tagged("calendar-input-data-none")?!1:n&&n.Name!=t||!n&&t?!1:!0},i.limitStart=!1,e)for(g=c.calendar&&c.calendar.calendars||yi(c),rt=g.length,y=0;y<rt;y++)l=g[y],l.end&&(e.Name==l.date.Name?i.endField=l.end.Name:e.Name==l.end.Name&&(i.startField=l.date.Name,ut=c.editRow(),i.limitStart=new Date(ut[l.date.Index]),i.limitStart.setHours(0,0,0,0)));switch(t){case"setInput":v(i.dataView,$app.input.elementToField(o),o.find("input"),i.date);break;case"clear":v(i.dataView,$app.input.elementToField(o),o.find("input"));break;case"hide":nt();break;case"attach":return r(t,i),!a;default:return r(t,i)}};r=function(r,f){function ii(){return a.calendar?a.calendar.activeCalendar:yi(a)[0]}function ri(n){return[t.MonthNames[n.getMonth()]+" "+n.getFullYear(),t.AbbreviatedMonthNames[n.getMonth()]+" "+n.getFullYear()]}function wt(){var n=i(c);return v.closest(".app-calendar-show-time").length&&at(p,n),n}function ui(n,i,r){var e,u,h,o,f,s;for(n.empty(),e="<table><thead>",r&&(u=$("<div><\/div>").appendTo(n),h=ri(i),u.text(h[0]),u[0].scrollWidth>u.innerWidth()&&u.text(h[1])),o=0;o<7;o++){var c=ct[o],l=t.ShortestDayNames[c],a=t.DayNames[c];e+='<th title="'+a+'">'+l+"<\/th>"}e+="<\/thead><tbody>"+yr(i.getFullYear(),i.getMonth(),!0)+"<\/tbody><\/table>";f=$(e).appendTo(n);n.is(".app-first-month")||f.find("td.app-prev-month").addClass("app-day-hidden");n.is(".app-last-month")||f.find("td.app-next-month").addClass("app-day-hidden");f.find("tr").filter(function(){return!$(this).find("td:not(.app-day-hidden), th").length}).addClass("app-week-hidden");s=f.find("td.app-current-day");s.length&&s.html('<span class="app-current-day">'+s.text()+"<\/span>");w(n,i)}function bt(n,t,i){$(i).each(function(){var r=this[1],i=this[0];if(r&&r!=0){i.indexOf(", ")<0&&(i=i+", "+i);var u=/(\d+), (\d+)/.exec(i),f=parseInt(u[1],10)-1,e=u[2],o=new Date(t.getFullYear(),f,e),s=b(n,o);s.addClass("app-has-data").attr("title",String.format("{0} ({1})",y.Label,r))}})}function kt(n,i,r){var h=new Date(i),u,p,e,w;dt(n,h);var c=n.find(".app-hour-selector").hide(),l=n.find(".app-minute-selector").hide(),b=l.find("li"),o=eu(h),a=n.find(".app-time-hour"),v=n.find(".app-time-minute"),k=n.find(".app-time-ampm"),s=n.find(".app-time-hand").removeClass("app-inner-ring app-dot"),f=0,y=t.AMDesignator=="";a.text(o.hour);v.text(o.minute);n.find(".app-cal-selected").removeClass("app-cal-selected");switch(r){case"Hour":a.addClass("app-cal-selected");c.show();u=i.getHours();y?u<12&&s.addClass("app-inner-ring"):u>=12&&(u-=12);f=u*30;p=c.find("li");p.eq(u).addClass("app-cal-selected");break;case"Minute":v.addClass("app-cal-selected");l.show();e=i.getMinutes();f=e*6;e%5!=0?s.addClass("app-dot"):b.eq(e/5).addClass("app-cal-selected")}f>360&&(f-=360);s.css("transform","rotate("+f+"deg)");y||(w=k.find("span"),w.eq(o.ampm==t.AMDesignator?0:1).addClass("app-cal-selected"))}function ut(){function oi(n,t){return s.is(":visible")?vt.activePage.attr("id")!=ai?!0:f.queryData&&!f.queryData(n,t)?!0:!1:!0}var hi=c.find(".app-scroll-inner"),b=c.find(".app-scroll-column > div"),dt=i(b.eq(rt)),nt=wt(),ci=h.getMonth(),r=v.find(".app-calendar-plugin-header div"),vi=r.text(),li=$.mobile.activePage.find(".app-wrapper"),gt=li.find(".app-calendar"),yi=gt.length&&gt.is(":visible"),ti=l.find(".app-scroll-inner"),n=new Date(h),ii=f.reloadData,ht,ri,tt,ct,u,at,o;switch(k){case"":r.html(String.format(vr,t.MonthNames[h.getMonth()],h.getFullYear(),t.MonthNames[h.getMonth()],h.getFullYear()));ht=r.find("a");ri=ht.first().outerWidth()+ht.eq(2).outerWidth();ri>r.innerWidth()-60&&r.html(String.format(vr,t.MonthNames[n.getMonth()],h.getFullYear(),t.AbbreviatedMonthNames[n.getMonth()],h.getFullYear()));(h.getFullYear()!=dt.getFullYear()||h.getMonth()!=dt.getMonth())&&(ii=!0,n.setMonth(n.getMonth()-rt),b.each(function(){var t=$(this);ui(t,n,!t.is(".app-first-month"));n.setMonth(n.getMonth()+1)}));et||f.limitEnd?b.each(function(){var t=$(this),n=i(t);t.find("td").filter(function(){var t=new Date(n),i=$(this);return(t.setMonth(i.closest("[data-cal-month]").attr("data-cal-month"),i.attr("data-cal-day")),i.is(".app-prev-month")?t.setMonth(n.getMonth()-1):i.is(".app-next-month")&&t.setMonth(n.getMonth()+1),et&&t<et)?!0:f.limitEnd&&t>f.limitEnd?!0:!1}).addClass("app-day-unselectable")}):b.find(".app-day-unselectable").removeClass("app-day-unselectable");function fi(){hi.css("marginLeft","")}g&&g!=""?ni(l,c,null,fi):fi();setTimeout(function(){var n=c.height();n>0&&(c.height(n),l.height(n))});break;case"selectmonth":r.html(String.format('<a class="ui-btn app-year-picker">{0}<\/a>',n.getFullYear()));n.setFullYear(n.getFullYear()-1);u=Math.floor(c.height()/3)-10;tt=function(){l.find(".app-scroll-column").each(function(){var r=$(this).empty(),i,f;for(w(r,n),i=0;i<12;i++)f=$(String.format('<div class="app-select-month ui-btn" data-cal-month="{0}" title="{2}">{1}<\/div>',i,t.AbbreviatedMonthNames[i],t.MonthNames[i])).css({height:u,lineHeight:u+"px"}).appendTo(r),nt.getMonth()==i&&nt.getFullYear()==n.getFullYear()&&f.addClass("app-selected");d(r);n.setFullYear(n.getFullYear()+1)});ti.css("marginLeft","")};g&&g!=""?g=="selectyear"?ni(l,l,tt):tt():ni(c,l,tt);break;case"selectyear":ct=n.getFullYear();n.setFullYear(n.getFullYear()-12);u=Math.floor(c.height()/3)-10;at=function(){l.find(".app-scroll-column").each(function(){var t=$(this).empty(),r,i;for(w(t,n),i=0;i<12;i++)r=$(String.format('<div class="app-select-year ui-btn" data-cal-year="{0}">{0}<\/div>',n.getFullYear())).css({height:u,lineHeight:u+"px"}).appendTo(t),n.getFullYear()==nt.getFullYear()&&r.addClass("app-selected"),n.setFullYear(n.getFullYear()+1);d(t)});ti.css("marginLeft",-v.width())};r.html(String.format("<span>{0} - {1}<\/span>",ct,ct+11));g!="selectyear"?ni(l,l,at):at()}st&&kt(p,h,it);var ei=s.data("calendar-onrefresh"),ai=vt.activePage.attr("id"),yt=y&&y.Name;if(ei&&ei({container:s,monthContainer:c,selectorContainer:l,timeContainer:p,dataView:a,mode:k,date:nt,startField:f.startField,endField:f.endField}),ii&&!f.hideDate&&!a._survey&&y.AllowQBE){var ut=new Date(h.getFullYear(),h.getMonth()),si=String.format("{0}-{1}",ut.getFullYear(),ci),ot=ft[y.Name],pt=c.find(".app-scroll-column").eq(1);pt.find(".app-has-data").removeClass("app-has-data").attr("title","");ot||(ot=ft[y.Name]={});o=ot[si];o?bt(pt,ut,o):(clearTimeout(fr),fr=setTimeout(function(){if(!oi(y,yt)){var u=[yt],n=new Date(ut),i=e[n.getDay()],t,r={},f=a._keyFields.map(function(n){return n.Name});i!=0&&n.setDate(n.getDate()-i);t=new Date(n);t.setDate(t.getDate()+7+35*rt);t.setSeconds(-1);r[y.Name]=["pivot-row1-month-raw","pivot-row2-day"];$app.execute({controller:a._controller,command:"Pivot",view:a._viewId,_filter:lt(a,y,null,n,t,f),fieldFilter:u,sort:"",pivotDefinitions:r,tags:a.get_tags(),success:function(n){var t=n.Pivots.pivot0;t&&(o=ot[si]=n.Pivots.pivot0.Data.slice(1),a.session("calendar-input-cache",ft),oi(y,yt)||bt(pt,ut,o))},error:function(n){$app.alert(String.format("{0}",n.get_message()))}})}},300))}return v}function fi(){var ni=a.extension().commandRow(),tt=!v.length,vt,nt,n,g;if(tt){v=$('<div class="app-calendar-plugin"><\/div>').prependTo(s);var ft=$('<div class="app-calendar-plugin-header"><div>&nbsp;<\/div><\/div>').appendTo(v),ti=$('<a href="#" class="app-calendar-plugin-loadleft ui-btn ui-btn-corner-all ui-btn-icon-notext ui-icon-carat-l"><\/a>').attr("title",o.Pager.Previous).prependTo(ft),ii=$('<a href="#" class="app-calendar-plugin-loadright ui-btn ui-btn-corner-all ui-btn-icon-notext ui-icon-carat-r"><\/a>').attr("title",o.Pager.Next).appendTo(ft),ht=new Date(h);c=$('<div class="app-month-container" data-draggable="calendar-mini"><\/div>').appendTo(v);var e=$('<div class="app-scroll-inner"><\/div>').appendTo(c),ct=$('<div class="app-scroll-column"><\/div>').appendTo(e),lt=$('<div class="app-scroll-column"><\/div>').appendTo(e),at=$('<div class="app-scroll-column"><\/div>').appendTo(e);if(l=$('<div class="app-date-selector-container" data-draggable="calendar-mini" style="display:none"><\/div').appendTo(v),vt=$('<div class="app-scroll-inner"><div class="app-scroll-column"><\/div><div class="app-scroll-column"><\/div><div class="app-scroll-column"><\/div><\/div>').appendTo(l),f.renderTime){p=$('<div class="app-time-container"><div class="app-time-header"><span class="app-time-hour app-cal-selected">12<\/span>:<span class="app-time-minute">00<\/span> <span class="app-time-ampm"><\/span><\/div> <div class="app-time-selector" data-draggable="calendar-mini-hand"><div class="app-hour-selector"><ul class="app-hour-list">'+(t.AMDesignator==""?"<li>00<\/li><li>1<\/li><li>2<\/li><li>3<\/li><li>4<\/li><li>5<\/li><li>6<\/li><li>7<\/li><li>8<\/li><li>9<\/li><li>10<\/li><li>11<\/li><li>12<\/li><li>13<\/li><li>14<\/li><li>15<\/li><li>16<\/li><li>17<\/li><li>18<\/li><li>19<\/li><li>20<\/li><li>21<\/li><li>22<\/li><li>23<\/li>":"<li>12<\/li><li>1<\/li><li>2<\/li><li>3<\/li><li>4<\/li><li>5<\/li><li>6<\/li><li>7<\/li><li>8<\/li><li>9<\/li><li>10<\/li><li>11<\/li>")+'<\/ul><\/div><div class="app-minute-selector" style="display: none"><ul class="app-minute-list"><li>00<\/li><li>05<\/li><li>10<\/li><li>15<\/li><li>20<\/li><li>25<\/li><li>30<\/li><li>35<\/li><li>40<\/li><li>45<\/li><li>50<\/li><li>55<\/li><\/ul><\/div><span class="app-time-hand app-transition"><span><\/span><\/span><\/div><\/div>').appendTo(s);var yt=p.find(".app-time-selector"),et=p.find(".app-time-ampm"),i=yt.height()/2,b=i*.815,pt=t.AMDesignator==""?i*.55:b,wt=p.find(".app-hour-list li"),bt=p.find(".app-minute-list li"),kt=t.AMDesignator?12:24,r;for(n=0;n<kt;n++)r=n*30/57.2958-Math.PI/2,nt=n>=12?b:pt,wt.eq(n).css({top:i+nt*Math.sin(r),left:i+nt*Math.cos(r)});for(n=0;n<12;n++)r=n*30/57.2958-Math.PI/2,bt.eq(n).css({top:i+b*Math.sin(r),left:i+b*Math.cos(r)});t.AMDesignator?et.html("<span>"+t.AMDesignator+"<\/span><br/><span>"+t.PMDesignator+"<\/span>"):et.hide();f.hideActionBar||(gt=$('<div class="app-calendar-action-bar"><a class="ui-btn ui-corner-all ui-mini ui-btn-inline app-calendar-btn-ok">'+o.ModalPopup.OkButton+'<\/a><a class="ui-btn ui-corner-all ui-mini ui-btn-inline app-calendar-btn-cancel">'+o.ModalPopup.CancelButton+'<\/a><a class="ui-btn ui-corner-all ui-mini ui-btn-inline app-calendar-btn-clear"/><\/div>').appendTo(s))}h.setMonth(h.getMonth()-rt);g=function(n){for(var i,t=0;t<rt;t++)i=$("<div><\/div>").appendTo(n),t==0&&i.addClass("app-first-month"),t==rt-1&&i.addClass("app-last-month"),h.setMonth(h.getMonth()+1)};g(ct);g(lt);g(at);d(e);h=ht}return s.find(".app-calendar-btn-clear").text(y.AllowNulls?ot.LookupClearAction:u.Today),st?s.addClass("app-calendar-show-time"):s.removeClass("app-calendar-show-time"),f.hideDate?s.addClass("app-calendar-hide-date"):s.removeClass("app-calendar-hide-date"),w(c,h),dt(p,h),(f.attachCallbacks||tt)&&(f.onrefresh&&s.data("calendar-onrefresh",f.onrefresh),f.onselect&&s.data("calendar-onselect",f.onselect),s.data("calendar-show-months",rt),k="",s.data("calendar-mode",k),it="Hour",s.data("calendar-time-mode",it)),f.reloadData=!0,ut(),v}function ei(){var n=f.date,t;if(k==""?(t=ti(c,n),w(c,n)):k=="selectmonth"?(t=l.find('.app-scroll-column[data-cal-year="'+n.getFullYear()+'"]'),w(l,n)):k=="selectyear"&&(t=l.find('.app-scroll-column .app-select-year[data-cal-year="'+n.getFullYear()+'"]').parent(),w(l,n)),t.length&&k==g){var r=t.closest(".app-scroll-inner"),u=t.position().left,i=parseInt(r.css("marginLeft"),10),e=i-u;Math.abs(e-i)<5?ut():r.stop().animate({marginLeft:i-u},ut)}else ut()}function oi(){var e=f.event,r=f.target,u=s.data("calendar-onselect"),n=f.date,t=r&&r.closest("td");t&&t.length&&(n=k==""?i(c):i(l),t&&n.setFullYear(parseInt(t.attr("data-cal-year"),10),parseInt(t.attr("data-cal-month"),10),parseInt(t.attr("data-cal-day"),10)),v.closest(".app-calendar-show-time").length&&at(p,n));u?u({container:v,monthContainer:c,selectorContainer:l,target:r,event:e,dataView:a,mode:k,timeMode:it,oldTimeMode:ht,showTime:st,date:n,startField:f.startField,endField:f.endField}):r.closest(".app-month-container").length&&(c.find(".app-selected").removeClass("app-selected"),b(c,n).addClass("app-selected"));f.date=h=n;kt(p,n,it)}function si(){a.session("calendar-input-cache",null);ft={};f.reloadData=!0;ut()}function hi(){a.session("calendar-input-cache",null);v.removeData();ft=null;s.remove()}var s=f.container,nt;s.is(".app-calendar-plugin")&&(s=s.parent());var v=s.find(".app-calendar-plugin"),c=v.find(".app-month-container"),l=v.find(".app-date-selector-container"),p=s.find(".app-time-container"),gt=s.find(".app-calendar-action-bar"),g=s.data("calendar-mode"),k=f.mode!=undefined?f.mode:g||"",ht=s.data("calendar-time-mode"),it=f.timeMode||ht||"Hour",rt=s.data("calendar-show-months")||f.months||1,a=f.dataView||n.dataView(),ft=a.session("calendar-input-cache")||{},yt=s.data("calendar-field"),y=f.field||yt||ii().date,pt=s.data("calendar-limit-start"),et=f.limitStart===undefined?pt:f.limitStart,st=f.showTime,h=new Date(f.date);h&&tt(h)||(h=i(c),st&&at(p,h));k!=g&&s.data("calendar-mode",k);it!=ht&&s.data("calendar-time-mode",it);pt!=et&&s.data("calendar-limit-start",et);yt!=y&&s.data("calendar-field",y);f.months&&s.data("calendar-show-months",f.months);switch(r){case"attach":nt=fi();break;case"destroy":nt=hi();break;case"refresh":nt=ut();break;case"setDate":nt=ei();break;case"getDate":nt=wt();break;case"click":nt=oi();break;case"clearCache":nt=si();break;default:$app.alert('Attempted to run CalendarControl("'+r+'").')}return nt};tr=function(n,t){this.dataView=n;this.calendar=n.calendar;this.calendars=t};tr.prototype={attach:function(t){var f=this.dataView,h=this,y,s;if(this.calendar||(this.calendar=this.dataView.calendar),this.lastFilter=f.combinedFilter().slice(),!f.get_isTagged("calendar-mini-disabled")){f.get_isTagged("calendar-mini-twomonths")&&(this.showMonths=2);var c=this.calendar?this.calendar.navigateDate||this.calendar.lastDate:null,l=f.calendar.activeCalendar||f.calendar.calendars[Object.keys(f.calendar.calendars)[0]],a=l.date,v=f.extension().commandRow();if(c=v?new Date(v[a.Index]):null,(!c||isNaN(c.getTime()))&&(c=new Date),y=t.find(".app-calendar-plugin").length>0,s=r("attach",{dataView:this.dataView,container:t.find(".ui-panel-inner"),date:c,months:this.showMonths,mode:"",hideActionBar:!0,onselect:function(t){var s=t.target,p=t.container,rt=t.monthContainer,ft=t.selectorContainer,et=t.event,l=t.dataView,ot=t.mode,f=t.date,k=s.closest("table"),c=s.closest("tr"),d=p.find("tr.app-selected"),g=p.find("td.app-selected"),w=c.hasClass("app-selected"),it=s.hasClass("app-selected"),b=$.mobile.activePage.find(".app-wrapper"),nt=b.find(".app-calendar"),a="",tt=nt.length&&nt.is(":visible"),v=l.calendar,o=s,i,y;if(tt){switch(v.mode){case"year":i="Month";o=k.find("tbody tr").filter(function(){return $(this).find("td.app-next-month, td.app-prev-month, th").length<7});break;case"month":w?(i="Week",o=c):(i="Month",o=k.find("tbody tr").filter(function(){return $(this).find("td.app-next-month, td.app-prev-month, th").length<7}));break;case"week":w?i="Day":(i="Week",o=c);break;case"day":it?(i="Week",o=c):i="Day";break;case"agenda":i="Agenda";v.animate=!0;v.enhancePrecision=!0}i=="Week"&&f.setDate(f.getDate()-e[f.getDay()])}else!g.length||s.is(".app-selected")?d.length&&w?a="=":(f.setDate(f.getDate()-e[f.getDay()]),y=new Date(f),y.setDate(f.getDate()+7),y.setSeconds(-1),a="$between$",o=c):a="=";d.add(g).removeClass("app-selected");o.addClass("ui-btn-active app-selected");setTimeout(function(){if(o.removeClass("ui-btn-active"),tt){if(l.calendar.navigateDate=new Date(f),i.toLowerCase()==v.mode)n.presenter("show",{id:l._id,name:"calendar",container:b});else{var t=ut(b.parent().find(".app-bar-header .app-bar-calendar"),u[i]);t&&t.trigger("vclick")}r("refresh",{container:p,dataView:l})}else h.filter(a,f,y)},oi)},onrefresh:function(n){var u=n.container,t=n.monthContainer,e=t.find(".app-scroll-column > div"),p=n.selectorContainer,r=n.dataView,w=n.mode,k=n.date,a=u.find(".app-calendar-plugin-fieldselector"),f=h.getActiveCalendar().date,v=f.Label,o=u.find(".glyphicon-filter"),s=r.combinedFilter(),c=$.mobile.activePage.find(".app-wrapper"),l=c.find(".app-calendar"),y=l.length&&l.is(":visible"),d=r.calendar;a.find(".text").text(v);clearTimeout(hr);hr=setTimeout(function(){var a,v,l,n;if(o.css("opacity","0"),h.filtered=!1,y){if(u.is(":visible")){if(e.find(".app-selected").removeClass("app-selected"),a=r.calendar,v=a.getMostVisibleBlock(c),!v)return;if(l=i(v),n=ti(t,l),!n||!n.length)return;switch(a.mode){case"year":case"month":n.find("table tr").filter(function(){return $(this).find("td.app-next-month, td.app-prev-month, th").length<7}).addClass("app-selected");break;case"week":b(n,l).parent().addClass("app-selected");break;case"day":b(n,l).addClass("app-selected")}}}else e.find(".app-selected").removeClass("app-selected"),s.length&&$(s).each(function(){var s=this,i,l,n;if(s.startsWith(f.Name)){if(i=/(\w+):(=|\$between\$)(%js%"(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z?)")/.exec(s),!i)return!1;o.css("opacity","1");h.filtered=!0;var u=r.convertStringToFieldValue(f,i[3]),a=ti(t,u),e=new Date(u),c=i[2]=="=";return(e.setDate(u.getDate()+(c?1:7)),e.setSeconds(-1),l=ti(t,e),!a.length&&!l.length)?!0:(n=b(t,u).add(b(t,e)),n&&n.length&&(c?n.addClass("app-selected"):n.parent().addClass("app-selected")),!1)}})},450);h.lastFilter=r.combinedFilter().slice()}}),s.addClass("app-show-request"),!y){var k=$('<a class="ui-btn ui-btn-icon-none app-has-droparrow app-calendar-plugin-fieldselector"><span class="glyphicon glyphicon-filter" style="opacity:0"><\/span><span class="text">'+a.Label+"<\/span><\/a>").appendTo(s),p=$('<div class="app-calendar-color-legend"><p class="app-item-desc app-item-desc-before"><\/p><ol><\/ol><\/div>').attr("data-calendar-for",l.name).appendTo(s).hide(),w=$('<a class="ui-btn ui-btn-icon-none app-has-droparrow app-legend-toggle"><\/a>').appendTo(p),d=$('<p class="app-item-desc app-item-desc-after"><\/p>').appendTo(p);$('<span class="app-see-more"><\/span>').text(o.Mobile.More).appendTo(w);$('<span class="app-see-less"><\/span>').text(u.Less).appendTo(w);s.on("show.sidebar.app",function(){var n=s.find(".app-month-container");n.length&&n.find(".app-scroll-inner").css("marginLeft","")})}return s}},refresh:function(){r("refresh",{container:n.sidebar().find(".app-calendar-plugin"),dataView:this.dataView})},getActiveCalendar:function(){return this.calendar?this.calendar.activeCalendar:this.calendars[Object.keys(this.calendars)[0]]},clearCache:function(){r("clearCache",{container:n.sidebar().find(".app-calendar-plugin"),dataView:this.dataView})},filterWithoutField:function(n){var t=this.getActiveCalendar().date.Name;return n.filter(function(n){return!n.startsWith(t)}).join("")},filter:function(t,i,u){var e=this,f=e.dataView,o=e.getActiveCalendar().date,s;f.extension()._instructed=!1;e.filtering=!0;switch(t){case"=":f.applyFieldFilter(o.Index,"=",[i]);break;case"$between$":f.applyFieldFilter(o.Index,"$between",[i,u]);break;case"clear":f.removeFromFilter(o);f.sync()}e.filtering=!1;s=r("refresh",{container:n.sidebar().find(".ui-panel-inner"),dataView:this.dataView})}};$(document).on("vclick",".app-calendar-color-legend",function(t){var r=$(t.target),ut=n.sidebar(),g,it,o,h,y,rt;if(r.is(".app-calendar-color-legend ol li, .app-calendar-color-legend ol li span")){t=r.is(".app-event")?r:r.find(".app-event");var ft=n.dataView(),u=ft.calendar,c=u.activeCalendar.colorMap,et=c.getVisibleColors().map(function(n){return c.color(n)}),l=$("body"),p=t.attr("class").match(/app-event-color-(\d+)/),w=l.attr("class").match(/app-event-filter-color-(\d+)/),b=!0;if(p){var k=parseInt(p[1],10),d="app-event-filter-color-"+k,ot=l.is("."+d);if(w&&(g=parseInt(w[1],10),b=et.indexOf(g)!=-1),c.clearFilter(),!ot&&b){l.addClass("app-event-filter "+d);var i=u.scrollable(),f=u.getFirstVisibleBlock(i),st=u.getLastVisibleBlock(i),nt=i.position().top,ht=nt+i.height(),e,a,v=!1,tt=!1;do it=f.find(".app-event.app-event-color-"+k),it.each(function(){var n=$(this),t=n.offset().top;if(t<nt)(u.mode=="month"||!e||e.offset().top<t)&&(e=n);else return t+n.height()>ht?(a=n,v=!0,!1):(tt=!0,v=!0,!1)}),f=f.next();while(!v&&f!=st&&f.length);if(!tt&&(a||e)){o=a||e;switch(u.mode){case"day":case"week":y=o.data("data-context");y&&(rt=y[1],h=s(rt,"find"));break;case"month":case"agenda":h=i.scrollTop()+o.offset().top-i.position().top+(o.height()-i.height())/2}h!=null&&n.animatedScroll(i,h)}}}return!1}if(r.is(".app-legend-toggle, .app-see-more, .app-see-less"))return n.callWithFeedback(r,function(){ut.find(".app-calendar-color-legend").toggleClass("app-see-all")}),!1}).on("vclick",".app-calendar-plugin-fieldselector",function(f){var d=$(f.target),c=d,v=c.closest(".app-calendar-plugin-fieldselector"),e=n.dataView(),o=e.calendarPlugin,l=c.closest(".app-calendar-plugin"),nt=l.data("calendar-mode"),y=l.find(".app-month-container"),tt=l.find(".app-date-selector-container"),it=c.closest("table"),h=[],k,a;o.filtered&&h.push({text:ot.ClearFilter,icon:"delete",callback:function(){o.filter("clear")}},{});$(o.calendars).each(function(){var n=this,t=n.date,i=o.getActiveCalendar().date;h.push({text:t.Label,icon:t==i?"check":"",callback:function(){if(e.calendar.preventNavigate=!0,i!=t){e.removeFromFilter(i);o.calendar.activeCalendar.colorMap.clearFilter();o.calendar.activeCalendar=n;var r=e.viewProp("calendarConfig");r.activeCalendar=n.name;e.viewProp("calendarConfig",r);o.calendar.clear(!0);e.sync()}}})});h.push({},{text:u.Today,icon:"calendar",callback:function(){r("setDate",{container:y.closest(".ui-panel-inner"),date:new Date,dataView:e,reloadData:!0})}});var p=$.mobile.activePage.find(".app-wrapper"),w=p.find(".app-calendar"),g=w.length&&w.is(":visible"),s,b=u.Sync;return g?(k=e.calendar.getMostVisibleBlock(p),s=i(k)):(a=e.extension().commandRow(),a&&(s=new Date(a[o.getActiveCalendar().date.Index]))),s&&!isNaN(s.getTime())&&(b=String.format("{0} {1}",t.MonthNames[s.getMonth()],s.getFullYear()),h.push({text:b,icon:"recycle",callback:function(){r("setDate",{container:y.closest(".ui-panel-inner"),date:s,dataView:e})}})),n.callWithFeedback(v,function(){n.listPopup({anchor:v,iconPos:"left",items:h})}),!1}).on("touchmove",".app-calendar-plugin, .app-calendar-plugin-container",function(n){if($(n.target).closest("[data-draggable]").length==0)return n.preventDefault(),!1}).on("vclick mousedown",".app-calendar-plugin, .app-calendar-plugin-container",function(u){var b,c,nt,l,lt,k;if(u.preventDefault(),a)return a=!1,!1;if(u.type=="mousedown")return!1;var tt=$(u.target),f=tt,s=n.dataView(),o=f.closest(".app-calendar-plugin").parent();o.length||(o=f.closest(".app-calendar-plugin-container"));var p=o.data("calendar-mode"),rt=o.find(".app-month-container"),vt=o.find(".app-date-selector-container"),w=o.find(".app-time-container"),ut=f.closest("table"),ft=o.data("calendar-show-months"),d=w.find(".app-time-selector"),v=d.find(".app-time-hand"),e;if(e=p==""?ut.length?i(ut.parent()):i(rt):i(vt),w.length&&at(w,e),f.is("span.app-current-day")&&(tt=f=f.closest("td")),f.is("td")){if(f.is(".app-day-unselectable"))return;if(rt.is(":animated"))return;r("click",{container:o,dataView:s,target:f,event:u})}else if(f.is(".ui-btn-icon-notext"))b=f.is(".app-calendar-plugin-loadleft"),p==""?(b?e.setMonth(e.getMonth()-ft):e.setMonth(e.getMonth()+ft),n.callWithFeedback(f,function(){r("setDate",{container:o,date:e,dataView:s})})):p=="selectmonth"?n.callWithFeedback(f,function(){e.setFullYear(e.getFullYear()+(b?-1:1));r("setDate",{container:o,date:e,dataView:s})}):p=="selectyear"&&n.callWithFeedback(f,function(){e.setFullYear(e.getFullYear()+(b?-12:12));r("setDate",{container:o,date:e,dataView:s})});else if(f.is(".app-month-picker"))n.callWithFeedback(f,function(){r("setDate",{container:o,date:e,mode:"selectmonth",dataView:s})});else if(f.is(".app-year-picker"))p!="selectyear"?(e.setFullYear(e.getFullYear()-5),n.callWithFeedback(f,function(){r("setDate",{container:o,date:e,mode:"selectyear",dataView:s})})):f.removeClass("ui-btn-active");else if(f.is(".app-select-month"))n.callWithFeedback(f,function(){e.setMonth(parseInt(f.attr("data-cal-month"),10));r("setDate",{container:o,date:e,mode:"",reloadData:!0,dataView:s})});else if(f.is(".app-select-year"))n.callWithFeedback(f,function(){e.setFullYear(parseInt(f.attr("data-cal-year"),10));r("setDate",{container:o,date:e,mode:"selectmonth",dataView:s})});else if(f.is(".app-time-hour"))n.callWithFeedback(f),v.removeClass("app-transition"),r("refresh",{container:o,timeMode:"Hour",showTime:!0,dataView:s}),setTimeout(function(){v.addClass("app-transition")}),it();else if(f.is(".app-time-minute"))n.callWithFeedback(f),v.removeClass("app-transition"),r("refresh",{container:o,timeMode:"Minute",showTime:!0,dataView:s}),setTimeout(function(){v.addClass("app-transition")}),it();else if(f.closest(".app-time-ampm").length)e=o.data("select-date")||e,c=e.getHours(),e.setHours(c+(c<12?12:-12)),dt(w,e),n.callWithFeedback(f),r("click",{container:o,dataView:s,target:f,event:u,date:e,showTime:!0}),it();else if(f.closest(".app-time-selector").length){e=o.data("select-date")||e;var et=t.AMDesignator=="",ot=d.offset(),yt=o.data("calendar-time-mode"),g=d.height()/2,st=$app.touch.lastTouch()||{x:u.pageX,y:u.pageY},ht=st.x-(g+ot.left),ct=st.y-(g+ot.top),pt=et?Math.sqrt(Math.pow(ht,2)+Math.pow(ct,2)):0,y=Math.atan2(ct,ht)+Math.PI/2;if(y<0&&(y+=Math.PI*2),y/=Math.PI*2,isNaN(y)){console.log("angle is NaN");return}it();switch(yt){case"Hour":c=Math.round(y*12);et?(nt=pt>g/1.5,nt&&(c+=12),c==24?c=12:c!=12||nt||(c=0)):(c==12&&(c=0),e.getHours()>=12&&(c+=12));e.setHours(c);dt(w,e);r("click",{container:o,dataView:s,target:f,event:u,date:e,showTime:!0,getDateFromInput:!0});v.one("transitionend",function(){v.removeClass("app-transition");r("click",{container:o,dataView:s,target:f,event:u,date:e,showTime:!0,timeMode:"Minute",getDateFromInput:!0});v.addClass("app-transition")});break;case"Minute":l=Math.round(y*60)%60;lt=Math.abs(e.getMinutes()-l);lt>=5&&(k=l%5,k>2?l+=5-k:l-=k);l>=60&&(l=0);e.setMinutes(l);r("click",{container:o,dataView:s,target:f,event:u,date:e,showTime:!0,getDateFromInput:!0})}}else f.is(".app-calendar-btn-ok")?(e=o.data("select-date"),n.callWithFeedback(f,function(){h("setInput",{dataView:s,container:o,date:e});h("hide",{container:o})})):f.is(".app-calendar-btn-cancel")?n.callWithFeedback(f,function(){h("hide",{container:o})}):f.is(".app-calendar-btn-clear")&&n.callWithFeedback(f,function(){h("clear",{dataView:s,container:o});h("hide",{container:o})});return!1}).on("touchstart mousedown pointerdown",".app-calendar-cover",function(n){return n.preventDefault(),h("hide",{container:$(".app-calendar-plugin-container")}),!1}).on("beforefocus.input.app",'[data-input][data-type="date"],[data-input][data-type="datetime"]',function(n){h("attach",{input:n.inputElement})||n.preventDefault()}).on("cancel.input.app",'[data-input][data-type="date"],[data-input][data-type="datetime"]',function(n){$(".app-data-input-helper").is(":visible")&&($(".app-data-input-helper").hide(),n.preventDefault())}).on("help.input.app",'[data-input][data-type="date"],[data-input][data-type="datetime"]',function(n){$(".app-data-input-helper").show();n.preventDefault()});$app.dragMan["calendar-mini"]={start:function(n){n.dir=n.target.closest(".ui-panel").length?"horizontal":"all";this._startX=n.x;this._maxMargin=-n.target.width()*2;this._inner=n.target.find(".app-scroll-inner").stop();this._originalMarginLeft=parseInt(this._inner.css("margin-left")||0,10);this._cancelMarginLeft=this._originalMarginLeft;this._startTime=+new Date},move:function(n){var t=this._originalMarginLeft+n.x-this._startX;t<0&&t>this._maxMargin?this._inner.css("marginLeft",t):(this._startX=n.x,this._originalMarginLeft=parseInt(this._inner.css("margin-left")||0,10))},end:function(n){var e=new Date-this._startTime<200,o,s,u,f;if(e&&Math.abs(this._startX-n.x)<10){this._inner.css("margin-left",this._originalMarginLeft);return}var h=n.target.closest(".app-calendar-plugin"),t=h.parent(),c=t.data("calendar-mode"),l=t.hasClass("app-calendar-show-time");columns=this._inner.find(".app-scroll-column");columnIndex=0;e?n.swipeRight||(columnIndex=2):(o=columns.first().width(),s=-parseInt(this._inner.css("marginLeft"),10),columnIndex=Math.round(s/o));u=columns.eq(columnIndex);f=i(c==""?u.children(":first"):u);l&&at(t.find(".app-time-container"),f);r("setDate",{container:t,date:f});a=!0;setTimeout(function(){a=!1},250)},cancel:function(){this._inner.animate({marginLeft:this._cancelMarginLeft})}};$app.dragMan["calendar-mini-hand"]={start:function(n){n.dir="all";this._startX=n.x;this._startY=n.y;n._timeSelector=n.target.closest(".app-time-selector");n._outerContainer=n._timeSelector.closest(".app-calendar-plugin-container");n._hand=n._timeSelector.find(".app-time-hand").removeClass("app-transition");n._timeSelectorPos=n._timeSelector.offset();n._timeMode=n._outerContainer.data("calendar-time-mode");n._height=n._timeSelector.height()/2;n._is24hour=t.AMDesignator=="";n._date=n._outerContainer.data("select-date");n._isPM=!n._is24hour&&n._date.getHours()>=12},move:function(n){var e=n.x-(n._height+n._timeSelectorPos.left),o=n.y-(n._height+n._timeSelectorPos.top),s=n._is24hour?Math.sqrt(Math.pow(e,2)+Math.pow(o,2)):0,i=Math.atan2(o,e)+Math.PI/2,t,f,u;i<0&&(i+=Math.PI*2);i/=Math.PI*2;switch(n._timeMode){case"Hour":t=Math.round(i*12);n._is24hour?(f=s>n._height/1.5,f&&(t+=12),t==24?t=12:t!=12||f||(t=0)):(t==12&&(t=0),n._isPM&&(t+=12));n._date.setHours(t);break;case"Minute":u=Math.round(i*60);u==60&&(u=0);n._date.setMinutes(u)}r("click",{container:n._outerContainer,date:n._date,target:n.target,showTime:!0})},end:function(n){n._hand.addClass("app-transition");it()},cancel:function(n){n._hand.addClass("app-transition")}};ir=function(n,t,i){this.dataView=n;this.calendar=t;this.map=i;this.map||(this.map={});this.count=0;for(var r in this.map)this.map.hasOwnProperty(r)&&this.count++};ir.prototype={color:function(n){if(n==undefined||n==null)return 0;var t=this,i=this.map[n];return typeof i=="undefined"&&(i=this.map[n]=1+this.count%iu,this.count++,t.calendar.color&&(clearTimeout(sr),sr=setTimeout(function(){t.dataView.viewProp("calendarColorMap-"+t.calendar.color.Name,t.map);t.dataView.calendarPlugin.refresh(!1,!0)},1e3))),i},className:function(n){return"app-event-color-"+this.color(n)},load:function(t){var i=this;clearTimeout(or);or=setTimeout(function(){var h=n.sidebar(),r=h.find(".app-calendar-color-legend"),v=h.find("a.app-legend-toggle"),c=r.find("ol"),u=i.calendar,f=u?u.color:null,l,e,w,a;if(!u||!f||!h.is(":visible")){r.length&&i.hide();return}if(l=f.Label,e=0,t||c.is(":empty")||u.name!=r.attr("data-calendar-for")){var y=i.dataView.calendar.getFirstVisibleBlock(),s=i.getVisibleColors(),p=r.data("calendar-colors")||[];if(!y||!y.hasClass("data-loaded")&&i.dataView.calendar.mode!="agenda")return;if(s.length==p.length&&s.join("")==p.join(""))return;r.data("calendar-colors",s);c.empty();s.forEach(function(n){var r=i.className(n),u=n||o.Data.NullValueInForms,t,f;r&&(t=$("<li><\/li>").text(u),f=$('<span class="app-event">&nbsp;<\/span>').addClass(r).appendTo(t),e++>=ar&&t.addClass("app-hidden"),t.appendTo(c));w=n});r.attr("data-calendar-for",u.name);f.AliasName&&f.AliasName.length&&(a=i.dataView.findField(f.AliasName),a&&(l=a.Label));r.find(".app-item-desc").text(l);e<=ar?v.addClass("app-hidden"):v.removeClass("app-hidden");e!=0&&u.color?r.removeClass("app-hidden"):r.addClass("app-hidden");i.show()}},450)},show:function(){var i=n.sidebar();if(i.is(":visible")&&this.dataView.calendar.mode!="year"){var t=i.find(".app-calendar-color-legend"),r=this.dataView.calendar.scrollable(),u=r.find(".app-calendar"),f=!t.is(":visible");!t.is(".app-hidden")&&u.is(":visible")&&t.find("ol li").length?f&&t.show():this.hide()}},hide:function(){var t=n.sidebar(),i=t.find(".app-calendar-color-legend");i.hide()},getVisibleColors:function(){var f=[],r=this.dataView.calendar,h=r.scrollable(),n=r.getFirstVisibleBlock(h),p=r.getLastVisibleBlock(h),e=r.mode=="agenda",c=e?r.activeCalendar.color.AliasName||r.activeCalendar.color.Name:3,t,l,u,a,v,o,y,s;if(r.mode!="year")while(n&&n.length){if(t=n.data("calendar-colors"),!t&&(n.hasClass("data-loaded")||e)){if(t=[],l=i(n),e)a=n.find(".app-event"),a.each(function(){var i=$(this).data("data-context"),n=i[c];t.indexOf(n)==-1&&t.push(n)});else{u=r.cache.select(l);for(v in u){o=u[v].rows||u.rows;for(y in o)s=o[y][c],t.indexOf(s)==-1&&t.push(s);if(r.mode.match(/day|week/))break}}n.data("calendar-colors",t)}if(t&&t.forEach(function(n){f.indexOf(n)==-1&&f.push(n)}),n[0]==p[0])break;n=n.next()}return f.sort()},clearFilter:function(){for(var t=[],n=0;n<=23;n++)t.push("app-event-filter app-event-filter-color-"+n);$("body").removeClass(t.join(" "))}}}(),function(){var r=!$app.touch.desktop(),n=window,u=$(n),i=$(window.body),f=i.is(".app-ios");$app.input.methods.richtext={extend:function(n){var u=this,i=n.inner,f=n.row,r=n.field;if(v=f[r.Index],t=v==null?resources.NullValueInForms:r.format(v),i.html(t),r.Rows&&i.height(r.Rows+"em"),n.editing)i.on("blur",function(){u.blur(i)})},focus:function(n){var t=n.position();n.attr("contentEditable","true").addClass("app-rich-text-editor")},blur:function(n){n.removeAttr("contentEditable").removeClass("app-rich-text-editor")}}}();